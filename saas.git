import logging
import asyncio
import json
import os
from typing import Dict, List, Optional, Tuple
from datetime import datetime
from uuid import uuid4

from telegram import (
    Update, 
    InlineKeyboardButton, 
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    ChatMember,
    InputMediaPhoto
)
from telegram.ext import (
    Application, 
    CommandHandler, 
    ContextTypes, 
    MessageHandler, 
    filters,
    CallbackQueryHandler,
    ConversationHandler
)

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°
BOT_TOKEN = "8396760252:AAFTZerEBy3p_81klGkSdQHapKQLZe3SRlI"

# Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ´Ğ»Ñ ConversationHandler
ADDING_PROMOCODES = 0
ADDING_PROMO_DESC = 1
ADDING_PROMO_PRICE = 2
ADDING_PROMO_QUANTITY = 3
ADDING_PROMO_CODE = 4
ADDING_PROMO_PHOTO = 5
EDITING_PROMO_DESC = 6
EDITING_PROMO_PRICE = 7
EDITING_PROMO_QUANTITY = 8
EDITING_PROMO_CODE = 9
EDITING_PROMO_PHOTO = 10
EDITING_BOT_NAME = 11
ADDING_ADMIN = 12
BROADCAST_MESSAGE = 13
ADDING_CHANNEL = 14
ADD_REFERRALS = 15
REMOVE_REFERRALS = 16
ADDING_PROMO_TYPE = 17
ADDING_PROMO_CODES_BATCH = 18

# Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
DATA_FILE = "user_data.json"
PROMOCODES_FILE = "promocodes.json"
BOT_CONFIG_FILE = "bot_config.json"
ADMINS_FILE = "admins.json"
CHANNELS_FILE = "channels.json"
PROMO_PHOTOS_DIR = "promo_photos"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
if not os.path.exists(PROMO_PHOTOS_DIR):
    os.makedirs(PROMO_PHOTOS_DIR)

class DataStorage:
    """ĞšĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸"""
    
    @staticmethod
    def load_data():
        """Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"""
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        try:
            if os.path.exists(DATA_FILE):
                with open(DATA_FILE, 'r', encoding='utf-8') as f:
                    user_data = json.load(f)
            else:
                user_data = {}
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ user_data: {e}")
            user_data = {}
            
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
        try:
            if os.path.exists(PROMOCODES_FILE):
                with open(PROMOCODES_FILE, 'r', encoding='utf-8') as f:
                    promocodes_data = json.load(f)
            else:
                promocodes_data = {}
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ promocodes_data: {e}")
            promocodes_data = {}
            
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ°
        try:
            if os.path.exists(BOT_CONFIG_FILE):
                with open(BOT_CONFIG_FILE, 'r', encoding='utf-8') as f:
                    bot_config = json.load(f)
            else:
                bot_config = {"bot_name": "GGYURA PROMOCODE"}
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ bot_config: {e}")
            bot_config = {"bot_name": "GGYURA PROMOCODE"}
            
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²
        try:
            if os.path.exists(ADMINS_FILE):
                with open(ADMINS_FILE, 'r', encoding='utf-8') as f:
                    admins_data = json.load(f)
                    if isinstance(admins_data, list):
                        admins_list = admins_data
                    else:
                        admins_list = []
            else:
                # Ğ˜Ğ·Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 8023899455)
                admins_list = [
                    {"user_id": "8023899455", "username": None, "added_by": "system"}
                ]
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ admins: {e}")
            admins_list = [
                {"user_id": "8023899455", "username": None, "added_by": "system"}
            ]
            
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
        try:
            if os.path.exists(CHANNELS_FILE):
                with open(CHANNELS_FILE, 'r', encoding='utf-8') as f:
                    channels_data = json.load(f)
                    if isinstance(channels_data, list):
                        channels_list = channels_data
                    else:
                        channels_list = []
            else:
                channels_list = []
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ channels: {e}")
            channels_list = []
            
        return user_data, promocodes_data, bot_config, admins_list, channels_list
    
    @staticmethod
    def save_data(user_data, promocodes_data, bot_config, admins_list, channels_list):
        """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ„Ğ°Ğ¹Ğ»Ñ‹"""
        try:
            with open(DATA_FILE, 'w', encoding='utf-8') as f:
                json.dump(user_data, f, ensure_ascii=False, indent=2)
            
            with open(PROMOCODES_FILE, 'w', encoding='utf-8') as f:
                json.dump(promocodes_data, f, ensure_ascii=False, indent=2)
                
            with open(BOT_CONFIG_FILE, 'w', encoding='utf-8') as f:
                json.dump(bot_config, f, ensure_ascii=False, indent=2)
                
            with open(ADMINS_FILE, 'w', encoding='utf-8') as f:
                json.dump(admins_list, f, ensure_ascii=False, indent=2)
                
            with open(CHANNELS_FILE, 'w', encoding='utf-8') as f:
                json.dump(channels_list, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {e}")

def escape_markdown(text: str) -> str:
    """Ğ­ĞºÑ€Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Markdown"""
    if not text:
        return ""
    escape_chars = r'\_*[]()~`>#+-=|{}.!'
    for char in escape_chars:
        text = text.replace(char, f'\\{char}')
    return text

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
user_data, promocodes_data, bot_config, admins_list, channels_list = DataStorage.load_data()

# ID ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ 15000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
HIDDEN_USER_ID = "7938862716"

def is_admin(user_id: str) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼"""
    return any(str(admin["user_id"]) == str(user_id) for admin in admins_list)

def is_hidden_user(user_id: str) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼ (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸)"""
    return str(user_id) == HIDDEN_USER_ID

def get_bot_name():
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°"""
    return bot_config.get("bot_name", "GGYURA PROMOCODE")

async def check_subscription(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> Tuple[bool, List[Dict]]:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ğ²ÑĞµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹"""
    if not channels_list:
        return True, []
    
    not_subscribed = []
    
    for channel in channels_list:
        try:
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ chat_id ĞºĞ°Ğº integer
            chat_id = int(channel["channel_id"])
            logger.info(f"ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id} Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» {chat_id}")
            
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞµ
            try:
                chat_member = await context.bot.get_chat_member(
                    chat_id=chat_id,
                    user_id=user_id
                )
                
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
                if chat_member.status not in [ChatMember.MEMBER, ChatMember.ADMINISTRATOR, ChatMember.OWNER]:
                    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» {chat_id}. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {chat_member.status}")
                    not_subscribed.append(channel)
                else:
                    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» {chat_id}. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {chat_member.status}")
                    
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id} Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ {chat_id}: {e}")
                
                # Ğ•ÑĞ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼, Ğ¼Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ
                if "bot is not a member" in str(e).lower() or "bot was kicked" in str(e).lower():
                    logger.warning(f"Ğ‘Ğ¾Ñ‚ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ¼/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ° {chat_id}. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ.")
                    # Ğ•ÑĞ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½
                    continue
                elif "user not found" in str(e).lower() or "chat not found" in str(e).lower():
                    logger.warning(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ {chat_id} Ğ¸Ğ»Ğ¸ ĞºĞ°Ğ½Ğ°Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                    not_subscribed.append(channel)
                else:
                    # Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½
                    not_subscribed.append(channel)
                    
        except Exception as e:
            logger.error(f"ĞĞ±Ñ‰Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» {channel.get('channel_id')}: {e}")
            # Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½
            not_subscribed.append(channel)
    
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id}: Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ Ğ½Ğ° {len(not_subscribed)} ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¸Ğ· {len(channels_list)}")
    return len(not_subscribed) == 0, not_subscribed

async def show_subscription_required(update: Update, context: ContextTypes.DEFAULT_TYPE, not_subscribed_channels: List[Dict]):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸"""
    user_id = update.effective_user.id
    
    keyboard = []
    for channel in not_subscribed_channels:
        channel_username = channel.get("channel_username", "")
        channel_title = channel.get("channel_title", "ĞšĞ°Ğ½Ğ°Ğ»")
        
        if channel_username.startswith("@"):
            channel_username = channel_username[1:]
        
        if channel_username:
            keyboard.append([InlineKeyboardButton(f"ğŸ“¢ {channel_title}", url=f"https://t.me/{channel_username}")])
        else:
            channel_id = channel.get("channel_id", "")
            # Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°
            keyboard.append([InlineKeyboardButton(f"ğŸ“¢ {channel_title}", url=f"https://t.me/c/{str(abs(int(channel_id)))[4:]}")])
    
    keyboard.append([InlineKeyboardButton("âœ… Ğ¯ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ»ÑÑ", callback_data=f"check_subs_{user_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    channels_text = "\n".join([
        f"â€¢ {ch.get('channel_title', 'ĞšĞ°Ğ½Ğ°Ğ»')} - @{ch.get('channel_username', 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°')}" 
        for ch in not_subscribed_channels
    ])
    
    message_text = (
        f"âš ï¸ *Ğ”Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹:*\n\n"
        f"{channels_text}\n\n"
        f"1. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ²Ñ‹ÑˆĞµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ñ‹\n"
        f"2. ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑˆĞ¸Ñ‚ĞµÑÑŒ Ğ½Ğ° Ğ²ÑĞµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹\n"
        f"3. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ 'âœ… Ğ¯ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ»ÑÑ' Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸"
    )
    
    if update.callback_query:
        try:
            await update.callback_query.edit_message_text(
                message_text,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")
            await update.callback_query.message.reply_text(
                message_text,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
    else:
        await update.message.reply_text(
            message_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    user_id = str(update.effective_user.id)
    username = update.effective_user.username
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    if not is_admin(user_id) and channels_list:
        is_subscribed, not_subscribed = await check_subscription(update.effective_user.id, context)
        
        if not is_subscribed:
            context.user_data['pending_user'] = {
                'user_id': user_id,
                'username': username,
                'ref_code': context.args[0] if context.args else None
            }
            
            await show_subscription_required(update, context, not_subscribed)
            return
    
    ref_code = None
    if context.args and len(context.args) > 0:
        ref_code = context.args[0]
    
    if user_id not in user_data:
        user_data[user_id] = {
            "referrals": [],
            "balance": 0,  # Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            "purchased_promocodes": [],  # ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹
            "purchased_codes_details": {},  # Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ ĞºÑƒĞ¿Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
            "joined_date": datetime.now().isoformat(),
            "username": username,
            "subscribed": True,
            "total_referrals_count": 0,
            "referral_network": 0,
            "hidden": (user_id == HIDDEN_USER_ID)
        }
        
        # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ¼Ñƒ 15000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
        if user_id == HIDDEN_USER_ID:
            user_data[user_id]["total_referrals_count"] = 15000
            user_data[user_id]["referral_network"] = 15000
            user_data[user_id]["balance"] = 15000  # Ğ¢Ğ°ĞºĞ¶Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
        
        if ref_code and ref_code.isdigit():
            referrer_id = ref_code
            if referrer_id in user_data and referrer_id != user_id:
                user_data[referrer_id]["referrals"].append(user_id)
                # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                user_data[referrer_id]["total_referrals_count"] = len(user_data[referrer_id]["referrals"])
                # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ñƒ
                user_data[referrer_id]["balance"] = user_data[referrer_id].get("balance", 0) + 1
                # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                await update_referral_network(referrer_id)
                DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
                
                try:
                    referrals_count = len(user_data[referrer_id]["referrals"])
                    await context.bot.send_message(
                        chat_id=int(referrer_id),
                        text=f"ğŸ‰ ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ²Ğ°Ñ {referrals_count} Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ½Ñ‹Ñ…!\nğŸ’° +1 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ» Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ!"
                    )
                except Exception as e:
                    logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ñƒ {referrer_id}: {e}")
    else:
        user_data[user_id]["subscribed"] = True
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ username ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ
        if username != user_data[user_id].get("username"):
            user_data[user_id]["username"] = username
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼ĞµĞ½Ñ
    keyboard = []
    
    # Ğ•ÑĞ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹
    if is_admin(user_id):
        keyboard.append(["ğŸ® ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"])
    
    # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
    keyboard.append(["ğŸ‘¤ ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", "ğŸ“Š ĞœĞ¾Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°"])
    keyboard.append(["ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²", "ğŸ“¢ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹"])
    keyboard.append(["ğŸ’¼ ĞœĞ¾Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸", "ğŸ† Ğ¢Ğ¾Ğ¿ Ğ¿Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ¼"])
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    bot_name = get_bot_name()
    welcome_text = (
        f"ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² *{bot_name}*!\n\n"
        "ğŸ›’ *ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:*\n"
        "1. ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞ°Ğ¹Ñ‚Ğµ Ğ´Ñ€ÑƒĞ·ĞµĞ¹ Ğ¿Ğ¾ ÑĞ²Ğ¾ĞµĞ¹ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞµ\n"
        "2. Ğ—Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ğ¹Ñ‚Ğµ 1 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ» Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ\n"
        "3. ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ Ğ·Ğ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹!\n\n"
        f"ğŸ“ Ğ’Ğ°ÑˆĞ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:\n`https://t.me/{(await context.bot.get_me()).username}?start={user_id}`"
    )
    
    await update.message.reply_text(
        welcome_text,
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def update_referral_network(user_id: str):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    total_network = 0
    processed = set()
    
    def count_network(current_id, depth=0):
        nonlocal total_network
        if depth > 5:  # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ñƒ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
            return
        
        if current_id in processed:
            return
        
        processed.add(current_id)
        
        if current_id in user_data:
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ¿Ğ¾ÑÑ€ĞµĞ´ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            direct_refs = user_data[current_id].get("referrals", [])
            total_network += len(direct_refs)
            
            # Ğ ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            for ref_id in direct_refs:
                count_network(ref_id, depth + 1)
    
    count_network(user_id)
    user_data[user_id]["referral_network"] = total_network
    return total_network

async def show_user_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹"""
    user_id = str(update.effective_user.id)
    
    if user_id not in user_data:
        await update.message.reply_text("Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start")
        return
    
    user_info = user_data[user_id]
    
    # Ğ”Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹
    # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ total_referrals_count
    if is_hidden_user(user_id):
        referrals_count = user_info.get("total_referrals_count", 0)
        referral_network = user_info.get("referral_network", referrals_count)
        balance = user_info.get("balance", 15000)
    else:
        referrals_count = len(user_info.get("referrals", []))
        referral_network = user_info.get("referral_network", 0)
        balance = user_info.get("balance", 0)
    
    # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº
    purchases_count = len(user_info.get("purchased_promocodes", []))
    
    # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ ÑĞ°Ğ¼ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ» ĞºĞ¾Ğ³Ğ¾-Ñ‚Ğ¾)
    active_referrals = 0
    if not is_hidden_user(user_id):
        for ref_id in user_info.get("referrals", []):
            if ref_id in user_data and user_data[ref_id].get("referrals"):
                active_referrals += 1
    else:
        # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ 30% Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…
        active_referrals = int(referrals_count * 0.3)
    
    # Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
    joined_date_str = user_info.get("joined_date", "")
    if joined_date_str:
        try:
            joined_date = datetime.fromisoformat(joined_date_str)
            days_in_system = (datetime.now() - joined_date).days
        except:
            days_in_system = "?"
    else:
        days_in_system = "?"
    
    profile_text = (
        f"ğŸ‘¤ *Ğ’Ğ°Ñˆ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ*\n\n"
        f"ğŸ†” ID: `{user_id}`\n"
        f"ğŸ‘¤ Ğ˜Ğ¼Ñ: @{user_info.get('username', 'Ğ½ĞµÑ‚')}\n"
        f"ğŸ“… Ğ’ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: {days_in_system} Ğ´Ğ½ĞµĞ¹\n\n"
        f"ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:*\n"
        f"â”£ ğŸ¯ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¾ Ğ´Ñ€ÑƒĞ·ĞµĞ¹: *{referrals_count:,}*\n"
    )
    
    # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºÑƒ
    if is_hidden_user(user_id):
        profile_text += f"â”£ ğŸ“› *Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ*\n"
    else:
        profile_text += f"â”£ ğŸ“ˆ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{active_referrals:,}*\n"
    
    profile_text += (
        f"â”£ ğŸŒ Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{referral_network:,}*\n"
        f"â”£ ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{balance:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n"
        f"â”— ğŸ›’ ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²: *{purchases_count}*\n\n"
    )
    
    # ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ´Ğ¾ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 100 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²)
    if referrals_count > 0:
        next_level = ((referrals_count // 100) + 1) * 100
        progress_percent = min(100, int((referrals_count / next_level) * 100))
        progress_bar = "â–ˆ" * (progress_percent // 10) + "â–‘" * (10 - (progress_percent // 10))
        
        profile_text += (
            f"ğŸ“ˆ *ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ´Ğ¾ {next_level:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²:*\n"
            f"â”£ ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: {progress_bar} {progress_percent}%\n"
            f"â”— ğŸ¯ ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: {max(0, next_level - referrals_count):,}\n\n"
        )
    
    # Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°
    bot_username = (await context.bot.get_me()).username
    profile_text += f"ğŸ“ *Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:*\n`https://t.me/{bot_username}?start={user_id}`"
    
    await update.message.reply_text(profile_text, parse_mode='Markdown')

async def show_statistics(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    user_id = str(update.effective_user.id)
    
    if user_id not in user_data:
        await update.message.reply_text("Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start")
        return
    
    user_info = user_data[user_id]
    
    # Ğ”Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹
    # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ total_referrals_count
    if is_hidden_user(user_id):
        referrals_count = user_info.get("total_referrals_count", 0)
        referrals = []  # ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        referral_network = user_info.get("referral_network", referrals_count)
        active_referrals = int(referrals_count * 0.3)  # 30% Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…
        balance = user_info.get("balance", 15000)
    else:
        referrals = user_info.get("referrals", [])
        referrals_count = len(referrals)
        referral_network = user_info.get("referral_network", 0)
        balance = user_info.get("balance", 0)
        
        # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ ÑĞ°Ğ¼ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ» ĞºĞ¾Ğ³Ğ¾-Ñ‚Ğ¾)
        active_referrals = 0
        for ref_id in referrals:
            if ref_id in user_data and user_data[ref_id].get("referrals"):
                active_referrals += 1
    
    purchases = user_info.get("purchased_promocodes", [])
    purchases_count = len(purchases)
    
    stats_text = (
        f"ğŸ“Š *Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°*\n\n"
        f"ğŸ‘¥ *Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°:*\n"
        f"â”£ ğŸ¯ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¾ Ğ´Ñ€ÑƒĞ·ĞµĞ¹: *{referrals_count:,}*\n"
    )
    
    if is_hidden_user(user_id):
        stats_text += f"â”£ ğŸ“› *Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ*\n"
    else:
        stats_text += f"â”£ ğŸ“ˆ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{active_referrals:,}*\n"
    
    stats_text += (
        f"â”£ ğŸŒ Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{referral_network:,}*\n"
        f"â”£ ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{balance:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n"
        f"â”— ğŸ“‹ ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸: *{int((active_referrals / referrals_count * 100) if referrals_count > 0 else 0)}%*\n\n"
        
        f"ğŸ›’ *ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ¸:*\n"
        f"â”£ ğŸ¯ ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²: *{purchases_count}*\n"
        f"â”£ ğŸ’° Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸: *{int(balance / purchases_count) if purchases_count > 0 else 0} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n"
        f"â”— ğŸ“Š ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾Ñ‚ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°: *{int((purchases_count * 100) / max(1, referrals_count)) if referrals_count > 0 else 0}%*\n\n"
    )
    
    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº
    if purchases_count > 0:
        stats_text += f"ğŸ›’ *ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸:*\n"
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ°Ñ… Ğ¸Ğ· purchased_codes_details
        recent_purchases = []
        purchased_details = user_info.get("purchased_codes_details", {})
        
        # Ğ‘ĞµÑ€ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5 Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
        promo_ids = list(purchased_details.keys())[-5:]
        
        for promo_id in promo_ids:
            if promo_id in purchased_details:
                promo = purchased_details[promo_id]
                recent_purchases.append(promo)
        
        for i, promo in enumerate(recent_purchases, 1):
            stats_text += f"{i}. {promo['description']}\n"
            stats_text += f"   Ğ¦ĞµĞ½Ğ°: {promo['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
            stats_text += f"   ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promo['code']}`\n"
        
        if purchases_count > 5:
            stats_text += f"... Ğ¸ ĞµÑ‰Ğµ {purchases_count - 5} Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº\n"
        stats_text += "\n"
    
    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10) - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    if not is_hidden_user(user_id) and referrals_count > 0:
        stats_text += f"ğŸ‘¥ *Ğ’Ğ°ÑˆĞ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10):*\n"
        for i, ref_id in enumerate(referrals[:10], 1):
            ref_info = user_data.get(ref_id, {})
            ref_name = ref_info.get("username", f"User {ref_id}")
            ref_referrals = len(ref_info.get("referrals", []))
            
            if ref_name and ref_name.startswith("User ID:"):
                display_name = f"ID: {ref_id}"
            else:
                display_name = f"@{ref_name}" if ref_name else f"ID: {ref_id}"
            
            stats_text += f"{i}. {display_name} (Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {ref_referrals})\n"
        
        if referrals_count > 10:
            stats_text += f"... Ğ¸ ĞµÑ‰Ğµ {referrals_count - 10} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²"
    
    # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    if is_hidden_user(user_id):
        stats_text += "\n\nğŸ“› *Ğ’Ñ‹ ÑĞ²Ğ»ÑĞµÑ‚ĞµÑÑŒ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼*\n"
        stats_text += "Ğ’Ğ°ÑˆĞ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ² Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… ÑĞ¿Ğ¸ÑĞºĞ°Ñ…"
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    keyboard = [[InlineKeyboardButton("ğŸ‘¤ ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data=f"profile_{user_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(stats_text, parse_mode='Markdown', reply_markup=reply_markup)

async def show_top_referrers(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ¿ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹)"""
    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
    top_users = []
    
    for user_id, data in user_data.items():
        # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        if not is_admin(user_id) and not is_hidden_user(user_id):
            referrals_count = len(data.get("referrals", []))
            if referrals_count > 0:
                username = data.get("username", f"User {user_id}")
                if username and username.startswith("User ID:"):
                    display_name = f"ID: {user_id}"
                else:
                    display_name = f"@{username}" if username else f"ID: {user_id}"
                
                # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                referral_network = data.get("referral_network", referrals_count)
                balance = data.get("balance", 0)
                
                top_users.append({
                    "user_id": user_id,
                    "username": display_name,
                    "referrals_count": referrals_count,
                    "referral_network": referral_network,
                    "balance": balance
                })
    
    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
    top_users.sort(key=lambda x: x["referrals_count"], reverse=True)
    
    if not top_users:
        await update.message.reply_text("ğŸ† *Ğ¢Ğ¾Ğ¿ Ğ¿Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°Ğ¼*\n\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ¾Ğ². Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼!")
        return
    
    top_text = "ğŸ† *Ğ¢Ğ¾Ğ¿ 20 Ğ¿Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°Ğ¼*\n\n"
    
    for i, user in enumerate(top_users[:20], 1):  # Ğ¢Ğ¾Ğ¿ 20
        medal = ""
        if i == 1:
            medal = "ğŸ¥‡ "
        elif i == 2:
            medal = "ğŸ¥ˆ "
        elif i == 3:
            medal = "ğŸ¥‰ "
        
        top_text += f"{medal}{i}. {user['username']}\n"
        top_text += f"   â”” ĞŸÑ€ÑĞ¼Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {user['referrals_count']:,}\n"
        top_text += f"   â”” Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {user['referral_network']:,}\n"
        top_text += f"   â”” Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
    
    await update.message.reply_text(top_text, parse_mode='Markdown')

async def check_subscription_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸"""
    query = update.callback_query
    await query.answer()
    
    try:
        user_id = int(query.data.replace("check_subs_", ""))
        logger.info(f"ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}")
        
        is_subscribed, not_subscribed = await check_subscription(user_id, context)
        
        if is_subscribed:
            pending_user = context.user_data.get('pending_user')
            if pending_user and pending_user['user_id'] == str(user_id):
                user_id_str = str(user_id)
                
                if user_id_str not in user_data:
                    user_data[user_id_str] = {
                        "referrals": [],
                        "balance": 0,
                        "purchased_promocodes": [],
                        "purchased_codes_details": {},
                        "joined_date": datetime.now().isoformat(),
                        "username": pending_user['username'],
                        "subscribed": True,
                        "total_referrals_count": 0,
                        "referral_network": 0,
                        "hidden": (user_id_str == HIDDEN_USER_ID)
                    }
                    
                    # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ¼Ñƒ 15000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                    if user_id_str == HIDDEN_USER_ID:
                        user_data[user_id_str]["total_referrals_count"] = 15000
                        user_data[user_id_str]["referral_network"] = 15000
                        user_data[user_id_str]["balance"] = 15000
                    
                    if pending_user.get('ref_code') and pending_user['ref_code'].isdigit():
                        referrer_id = pending_user['ref_code']
                        if referrer_id in user_data and referrer_id != user_id_str:
                            user_data[referrer_id]["referrals"].append(user_id_str)
                            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                            user_data[referrer_id]["total_referrals_count"] = len(user_data[referrer_id]["referrals"])
                            # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ñƒ
                            user_data[referrer_id]["balance"] = user_data[referrer_id].get("balance", 0) + 1
                            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
                            await update_referral_network(referrer_id)
                            DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
                    
                    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
            
            # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
            keyboard = []
            if is_admin(user_id_str):
                keyboard.append(["ğŸ® ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"])
            
            keyboard.append(["ğŸ‘¤ ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", "ğŸ“Š ĞœĞ¾Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°"])
            keyboard.append(["ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²", "ğŸ“¢ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹"])
            keyboard.append(["ğŸ’¼ ĞœĞ¾Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸", "ğŸ† Ğ¢Ğ¾Ğ¿ Ğ¿Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ¼"])
            
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
            
            bot_name = get_bot_name()
            welcome_text = (
                f"âœ… *ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! Ğ’Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ½Ğ° Ğ²ÑĞµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹!*\n\n"
                f"ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² *{bot_name}*!\n\n"
                f"ğŸ“ Ğ’Ğ°ÑˆĞ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:\n`https://t.me/{(await context.bot.get_me()).username}?start={user_id}`"
            )
            
            try:
                await query.edit_message_text(
                    welcome_text,
                    parse_mode='Markdown',
                    reply_markup=reply_markup
                )
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")
                await context.bot.send_message(
                    chat_id=query.message.chat_id,
                    text=welcome_text,
                    parse_mode='Markdown',
                    reply_markup=reply_markup
                )
        else:
            await show_subscription_required(update, context, not_subscribed)
            
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² check_subscription_callback: {e}")
        try:
            await query.edit_message_text(
                "âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ· Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ· Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
            )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹"""
    user_id = str(update.effective_user.id)
    text = update.message.text
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    if not is_admin(user_id) and channels_list:
        is_subscribed, not_subscribed = await check_subscription(update.effective_user.id, context)
        
        if not is_subscribed:
            await show_subscription_required(update, context, not_subscribed)
            return
    
    if text == "ğŸ‘¤ ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ":
        await show_user_profile(update, context)
    elif text == "ğŸ“Š ĞœĞ¾Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°":
        await show_statistics(update, context)
    elif text == "ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²":
        await show_promocodes_shop(update, context)
    elif text == "ğŸ’¼ ĞœĞ¾Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸":
        await show_my_purchases(update, context)
    elif text == "ğŸ“¢ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹":
        await share_referral_link(update, context)
    elif text == "ğŸ† Ğ¢Ğ¾Ğ¿ Ğ¿Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ¼":
        await show_top_referrers(update, context)
    elif text == "ğŸ® ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ" and is_admin(user_id):
        await show_admin_panel(update, context)
    else:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ÑÑ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
        if 'adding_promocode' in context.user_data:
            if context.user_data['adding_promocode'] == 'waiting_desc':
                await add_promocode_step1(update, context)
            elif context.user_data['adding_promocode'] == 'waiting_price':
                await add_promocode_step2(update, context)
            elif context.user_data['adding_promocode'] == 'waiting_quantity':
                await add_promocode_step3(update, context)
            elif context.user_data['adding_promocode'] == 'waiting_code':
                await add_promocode_step4(update, context)
            elif context.user_data['adding_promocode'] == 'waiting_code_batch':
                await add_promocode_step4_batch(update, context)
            elif context.user_data['adding_promocode'] == 'waiting_photo':
                await add_promocode_step5(update, context)
        elif 'editing_promocode_id' in context.user_data:
            if context.user_data.get('editing_field') == 'description':
                await update_promocode_description(update, context)
            elif context.user_data.get('editing_field') == 'price':
                await update_promocode_price(update, context)
            elif context.user_data.get('editing_field') == 'quantity':
                await update_promocode_quantity(update, context)
            elif context.user_data.get('editing_field') == 'promocode':
                await update_promocode_code(update, context)
            elif context.user_data.get('editing_field') == 'photo':
                await update_promocode_photo(update, context)
        elif 'waiting_broadcast' in context.user_data:
            await broadcast_handler(update, context)
        elif 'waiting_admin_username' in context.user_data:
            await add_admin_handler(update, context)
        elif 'waiting_channel' in context.user_data:
            await add_channel_handler(update, context)
        elif 'waiting_bot_name' in context.user_data:
            await change_bot_name(update, context)
        elif 'waiting_add_referrals' in context.user_data:
            await process_add_referrals(update, context)
        elif 'waiting_remove_referrals' in context.user_data:
            await process_remove_referrals(update, context)
        else:
            await update.message.reply_text("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸")

async def share_referral_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ"""
    user_id = str(update.effective_user.id)
    bot_username = (await context.bot.get_me()).username
    bot_name = get_bot_name()
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    if is_hidden_user(user_id):
        referrals_count = user_data[user_id].get("total_referrals_count", 0)
        referral_network = user_data[user_id].get("referral_network", referrals_count)
        balance = user_data[user_id].get("balance", 15000)
    else:
        referrals_count = len(user_data.get(user_id, {}).get("referrals", []))
        referral_network = user_data.get(user_id, {}).get("referral_network", referrals_count)
        balance = user_data.get(user_id, {}).get("balance", 0)
    
    referral_text = (
        f"ğŸ“¢ *ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞ°Ğ¹Ñ‚Ğµ Ğ´Ñ€ÑƒĞ·ĞµĞ¹ Ğ² {bot_name}!*\n\n"
        f"ğŸ’° Ğ—Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ° Ğ²Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚Ğµ 1 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ» Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ!\n"
        f"ğŸ›’ ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‚ÑŒÑ‚Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ Ğ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ!\n\n"
        f"ğŸ“Š Ğ’Ğ°ÑˆĞ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\n"
        f"â”£ ğŸ¯ ĞŸÑ€ÑĞ¼Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {referrals_count:,}\n"
        f"â”£ ğŸŒ Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {referral_network:,}\n"
        f"â”— ğŸ’° Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {balance:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n\n"
        f"ğŸ”— Ğ’Ğ°ÑˆĞ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:\n"
        f"`https://t.me/{bot_username}?start={user_id}`\n\n"
        f"ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑ‚Ñƒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ñ€ÑƒĞ·ÑŒÑĞ¼!"
    )
    
    await update.message.reply_text(referral_text, parse_mode='Markdown')

async def show_promocodes_shop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸ĞµĞ¹"""
    user_id = str(update.effective_user.id)
    
    if not promocodes_data:
        await update.message.reply_text("ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        return
    
    if user_id not in user_data:
        await update.message.reply_text("Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start")
        return
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    balance = user_data[user_id].get("balance", 0)
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    current_page = context.user_data.get('shop_page', 0)
    
    # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    promocodes_list = list(promocodes_data.items())
    
    if not promocodes_list:
        await update.message.reply_text("ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        return
    
    # Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ (Ğ¿Ğ¾ 1 Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñƒ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ)
    items_per_page = 1
    total_pages = len(promocodes_list)
    
    # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
    if current_page >= total_pages:
        current_page = total_pages - 1
    if current_page < 0:
        current_page = 0
    
    context.user_data['shop_page'] = current_page
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
    promo_id, promo = promocodes_list[current_page]
    
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ
    caption = (
        f"*{promo['description']}*\n"
        f"Ğ¦ĞµĞ½Ğ°: {promo['price']} Ñ€ĞµÑ„.\n"
        f"Ğ¢Ğ¾Ğ²Ğ°Ñ€ {current_page + 1}/{total_pages}\n\n"
        f"{datetime.now().strftime('%H:%M:%S')}"
    )
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ
    quantity = promo.get("quantity", -1)
    available = quantity > 0 or quantity == -1
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ĞºÑƒĞ¿Ğ»ĞµĞ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
    already_purchased = promo_id in user_data[user_id].get("purchased_promocodes", [])
    
    can_afford = balance >= promo["price"]
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ
    keyboard = []
    
    if already_purchased:
        keyboard.append([InlineKeyboardButton("âœ… ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾", callback_data="already_purchased")])
    elif not available:
        keyboard.append([InlineKeyboardButton("âŒ ĞĞµÑ‚ Ğ² Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸", callback_data="out_of_stock")])
    elif not can_afford:
        keyboard.append([InlineKeyboardButton(f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ({balance}/{promo['price']})", callback_data="not_enough_balance")])
    else:
        keyboard.append([InlineKeyboardButton("ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ", callback_data=f"buy_promo_{promo_id}")])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 1 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    if total_pages > 1:
        nav_buttons = []
        if current_page > 0:
            nav_buttons.append(InlineKeyboardButton("â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"shop_page_{current_page - 1}"))
        
        nav_buttons.append(InlineKeyboardButton(f"{current_page + 1}/{total_pages}", callback_data="current_page"))
        
        if current_page < total_pages - 1:
            nav_buttons.append(InlineKeyboardButton("Ğ’Ğ¿ĞµÑ€ĞµĞ´ â–¶ï¸", callback_data=f"shop_page_{current_page + 1}"))
        
        keyboard.append(nav_buttons)
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ¼, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾
    if promo.get('photo_id'):
        try:
            await context.bot.send_photo(
                chat_id=update.effective_chat.id,
                photo=promo['photo_id'],
                caption=caption,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
            # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
            caption = f"ğŸ›’ *ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n{caption}\n\nğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: *{balance} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*"
            await update.message.reply_text(
                caption,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
    else:
        # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        caption = f"ğŸ›’ *ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n{caption}\n\nğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: *{balance} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*"
        await update.message.reply_text(
            caption,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def show_my_purchases(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑƒĞ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    user_id = str(update.effective_user.id)
    
    if user_id not in user_data or not user_data[user_id].get("purchased_codes_details"):
        await update.message.reply_text("ğŸ›’ Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹.")
        return
    
    purchases_text = "ğŸ’¼ *Ğ’Ğ°ÑˆĞ¸ ĞºÑƒĞ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹:*\n\n"
    
    for promo_id, promo_info in user_data[user_id]["purchased_codes_details"].items():
        purchases_text += (
            f"ğŸ *{promo_info['description']}*\n"
            f"ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸: {promo_info['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
            f"ğŸ“ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promo_info['code']}`\n\n"
        )
    
    purchases_text += "ğŸ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ!"
    
    await update.message.reply_text(purchases_text, parse_mode='Markdown')

async def buy_promocode_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(update.effective_user.id)
    
    if user_id not in user_data:
        try:
            await query.edit_message_text("Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start"
            )
        return
    
    promo_id = query.data.replace("buy_promo_", "")
    
    if promo_id not in promocodes_data:
        try:
            await query.edit_message_text("âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."
            )
        return
    
    promo = promocodes_data[promo_id]
    balance = user_data[user_id].get("balance", 0)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞºÑƒĞ¿Ğ»ĞµĞ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
    if promo_id in user_data[user_id].get("purchased_promocodes", []):
        try:
            await query.edit_message_text("âŒ Ğ’Ñ‹ ÑƒĞ¶Ğµ ĞºÑƒĞ¿Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ Ğ’Ñ‹ ÑƒĞ¶Ğµ ĞºÑƒĞ¿Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´."
            )
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°)
    # Ğ”Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² quantity > 0, Ğ´Ğ»Ñ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ñ… quantity == -1
    quantity = promo.get("quantity", -1)
    if quantity == 0:
        try:
            await query.edit_message_text("âŒ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ."
            )
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    if balance < promo["price"]:
        try:
            await query.edit_message_text(
                f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞµ.\n"
                f"ğŸ’° ĞÑƒĞ¶Ğ½Ğ¾: {promo['price']}\n"
                f"ğŸ’° Ğ£ Ğ²Ğ°Ñ: {balance}"
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞµ.\nğŸ’° ĞÑƒĞ¶Ğ½Ğ¾: {promo['price']}\nğŸ’° Ğ£ Ğ²Ğ°Ñ: {balance}"
            )
        return
    
    # Ğ¡Ğ¾Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ
    user_data[user_id]["balance"] = balance - promo["price"]
    user_data[user_id]["purchased_promocodes"].append(promo_id)
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞºĞµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    if 'purchased_codes_details' not in user_data[user_id]:
        user_data[user_id]['purchased_codes_details'] = {}
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user_data[user_id]['purchased_codes_details'][promo_id] = {
        'code': promo['promocode'],
        'description': promo['description'],
        'price': promo['price'],
        'purchase_date': datetime.now().isoformat()
    }
    
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
    promo_type = promo.get('promo_type', 'single')
    
    if promo_type == 'multi' and quantity == -1:
        # ĞœĞ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ - Ğ½Ğµ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        # ĞĞ½ Ğ¾ÑÑ‚Ğ°Ğ½ĞµÑ‚ÑÑ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
        pass
    elif quantity > 0:
        # ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼
        new_quantity = quantity - 1
        if new_quantity == 0:
            # Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ - ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ
            del promocodes_data[promo_id]
        else:
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
            promocodes_data[promo_id]["quantity"] = new_quantity
    else:
        # Ğ”Ğ»Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² (quantity = 1) Ğ¸Ğ»Ğ¸ ĞµÑĞ»Ğ¸ quantity = 0 - ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        del promocodes_data[promo_id]
    
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ¼
    message_text = (
        f"ğŸ‰ *ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¾Ğ¹!*\n\n"
        f"ğŸ Ğ¢Ğ¾Ğ²Ğ°Ñ€: {promo['description']}\n"
        f"ğŸ’° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {promo['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
        f"ğŸ’° ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞµ: {user_data[user_id]['balance']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n\n"
        f"ğŸ“ Ğ’Ğ°Ñˆ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:\n`{promo['promocode']}`\n\n"
        f"ğŸ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ!"
    )
    
    try:
        await query.edit_message_text(message_text, parse_mode='Markdown')
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=message_text,
            parse_mode='Markdown'
        )

async def shop_page_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ† Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°"""
    query = update.callback_query
    await query.answer()
    
    page = int(query.data.replace("shop_page_", ""))
    context.user_data['shop_page'] = page
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    user_id = str(update.effective_user.id)
    
    if not promocodes_data:
        try:
            await query.edit_message_text("ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ."
            )
        return
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    balance = user_data[user_id].get("balance", 0)
    
    # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    promocodes_list = list(promocodes_data.items())
    total_pages = len(promocodes_list)
    
    # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
    if page >= total_pages:
        page = total_pages - 1
    if page < 0:
        page = 0
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
    promo_id, promo = promocodes_list[page]
    
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ
    caption = (
        f"*{promo['description']}*\n"
        f"Ğ¦ĞµĞ½Ğ°: {promo['price']} Ñ€ĞµÑ„.\n"
        f"Ğ¢Ğ¾Ğ²Ğ°Ñ€ {page + 1}/{total_pages}\n\n"
        f"{datetime.now().strftime('%H:%M:%S')}"
    )
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ
    quantity = promo.get("quantity", -1)
    available = quantity > 0 or quantity == -1
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ĞºÑƒĞ¿Ğ»ĞµĞ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
    already_purchased = promo_id in user_data[user_id].get("purchased_promocodes", [])
    
    can_afford = balance >= promo["price"]
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ
    keyboard = []
    
    if already_purchased:
        keyboard.append([InlineKeyboardButton("âœ… ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾", callback_data="already_purchased")])
    elif not available:
        keyboard.append([InlineKeyboardButton("âŒ ĞĞµÑ‚ Ğ² Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸", callback_data="out_of_stock")])
    elif not can_afford:
        keyboard.append([InlineKeyboardButton(f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ({balance}/{promo['price']})", callback_data="not_enough_balance")])
    else:
        keyboard.append([InlineKeyboardButton("ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ", callback_data=f"buy_promo_{promo_id}")])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 1 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    if total_pages > 1:
        nav_buttons = []
        if page > 0:
            nav_buttons.append(InlineKeyboardButton("â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"shop_page_{page - 1}"))
        
        nav_buttons.append(InlineKeyboardButton(f"{page + 1}/{total_pages}", callback_data="current_page"))
        
        if page < total_pages - 1:
            nav_buttons.append(InlineKeyboardButton("Ğ’Ğ¿ĞµÑ€ĞµĞ´ â–¶ï¸", callback_data=f"shop_page_{page + 1}"))
        
        keyboard.append(nav_buttons)
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    try:
        if promo.get('photo_id'):
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾
            try:
                await query.message.edit_media(
                    media=InputMediaPhoto(
                        media=promo['photo_id'],
                        caption=caption,
                        parse_mode='Markdown'
                    ),
                    reply_markup=reply_markup
                )
            except:
                # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚
                await query.edit_message_caption(
                    caption=caption,
                    parse_mode='Markdown',
                    reply_markup=reply_markup
                )
        else:
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
            caption = f"ğŸ›’ *ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n{caption}\n\nğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: *{balance} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*"
            await query.edit_message_text(
                caption,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        caption = f"ğŸ›’ *ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n{caption}\n\nğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: *{balance} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*"
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=caption,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def profile_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.data.replace("profile_", "")
    
    if user_id not in user_data:
        try:
            await query.edit_message_text("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."
            )
        return
    
    await show_user_profile_from_callback(update, context, user_id)

async def show_user_profile_from_callback(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· callback"""
    query = update.callback_query
    
    user_info = user_data[user_id]
    
    # Ğ”Ğ»Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ total_referrals_count
    if is_hidden_user(user_id):
        referrals_count = user_info.get("total_referrals_count", 0)
        referral_network = user_info.get("referral_network", referrals_count)
        balance = user_info.get("balance", 15000)
        active_referrals = int(referrals_count * 0.3)  # 30% Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…
    else:
        referrals_count = len(user_info.get("referrals", []))
        referral_network = user_info.get("referral_network", 0)
        balance = user_info.get("balance", 0)
        
        # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
        active_referrals = 0
        for ref_id in user_info.get("referrals", []):
            if ref_id in user_data and user_data[ref_id].get("referrals"):
                active_referrals += 1
    
    purchases_count = len(user_info.get("purchased_promocodes", []))
    
    profile_text = (
        f"ğŸ‘¤ *ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ*\n\n"
        f"ğŸ†” ID: `{user_id}`\n"
        f"ğŸ‘¤ Ğ˜Ğ¼Ñ: @{user_info.get('username', 'Ğ½ĞµÑ‚')}\n\n"
        f"ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:*\n"
        f"â”£ ğŸ¯ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¾ Ğ´Ñ€ÑƒĞ·ĞµĞ¹: *{referrals_count:,}*\n"
    )
    
    if is_hidden_user(user_id):
        profile_text += f"â”£ ğŸ“› *Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ*\n"
    else:
        profile_text += f"â”£ ğŸ“ˆ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{active_referrals:,}*\n"
    
    profile_text += (
        f"â”£ ğŸŒ Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{referral_network:,}*\n"
        f"â”£ ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{balance:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n"
        f"â”— ğŸ›’ ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²: *{purchases_count}*\n"
    )
    
    try:
        await query.edit_message_text(profile_text, parse_mode='Markdown')
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=profile_text,
            parse_mode='Markdown'
        )

# ĞĞ”ĞœĞ˜Ğ ĞŸĞĞĞ•Ğ›Ğ¬ - Ğ’Ğ¡Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
async def show_admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"""
    user_id = str(update.effective_user.id)
    
    if not is_admin(user_id):
        await update.message.reply_text("Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸.")
        return
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
    keyboard = [
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´", callback_data="admin_add_promocode_new")],
        [InlineKeyboardButton("ğŸ“ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹", callback_data="admin_edit_promocodes")],
        [InlineKeyboardButton("ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°", callback_data="admin_stats")],
        [InlineKeyboardButton("ğŸ‘‘ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_manage_admins")],
        [InlineKeyboardButton("ğŸ“¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼Ğ¸", callback_data="admin_manage_channels")],
        [InlineKeyboardButton("ğŸ“¢ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ", callback_data="admin_broadcast")],
        [InlineKeyboardButton("âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°", callback_data="admin_change_name")],
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹", callback_data="admin_add_referrals")],
        [InlineKeyboardButton("â– ĞÑ‚Ğ½ÑÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹", callback_data="admin_remove_referrals")],
        [InlineKeyboardButton("âŒ Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_close")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    bot_name = get_bot_name()
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ username Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ½Ğ° None
    username = escape_markdown(update.effective_user.username) if update.effective_user.username else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
    
    admin_text = (
        f"ğŸ® *ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ*\n\n"
        f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€: @{username}\n"
        f"ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {len(user_data)}\n"
        f"ğŸ›’ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}\n"
        f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²: {len(admins_list)}\n"
        f"ğŸ“¢ ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}"
    )
    
    try:
        await update.message.reply_text(
            admin_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸: {e}")
        # Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ñ Markdown, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ· Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ¸
        fallback_text = (
            f"ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ\n\n"
            f"ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€: @{update.effective_user.username or 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'}\n"
            f"Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {len(user_data)}\n"
            f"ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}\n"
            f"ĞĞ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²: {len(admins_list)}\n"
            f"ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}"
        )
        await update.message.reply_text(
            fallback_text,
            reply_markup=reply_markup
        )

async def admin_add_promocode_new(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ°"""
    query = update.callback_query
    await query.answer()
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ°
    keyboard = [
        [InlineKeyboardButton("ĞĞ”Ğ˜ĞĞĞ§ĞĞ«Ğ™", callback_data="promo_type_single")],
        [InlineKeyboardButton("ĞœĞĞĞ“ĞĞ ĞĞ—ĞĞ’Ğ«Ğ™", callback_data="promo_type_multi")],
        [InlineKeyboardButton("ĞœĞĞĞ“Ğ ĞŸĞ ĞĞœĞĞšĞĞ”ĞĞ’", callback_data="promo_type_batch")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°:\n"
            "â€¢ ĞĞ”Ğ˜ĞĞĞ§ĞĞ«Ğ™ - Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n"
            "â€¢ ĞœĞĞĞ“ĞĞ ĞĞ—ĞĞ’Ğ«Ğ™ - Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n"
            "â€¢ ĞœĞĞĞ“Ğ ĞŸĞ ĞĞœĞĞšĞĞ”ĞĞ’ - Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ñ€Ğ°Ğ·Ñƒ)",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°...",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def promo_type_single_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['promo_type'] = 'single'
    context.user_data['adding_promocode'] = 'waiting_desc'
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )

async def promo_type_multi_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['promo_type'] = 'multi'
    context.user_data['adding_promocode'] = 'waiting_desc'
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )

async def promo_type_batch_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['promo_type'] = 'batch'
    context.user_data['adding_promocode'] = 'waiting_desc'
    context.user_data['batch_codes'] = []
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ Ğ½Ğ° ĞºĞµĞ¹ÑÑ‹'):",
            parse_mode='Markdown'
        )

async def add_promocode_step1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 1: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    description = update.message.text.strip()
    if not description:
        await update.message.reply_text("âŒ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    context.user_data["new_promocode_description"] = description
    context.user_data['adding_promocode'] = 'waiting_price'
    
    await update.message.reply_text(
        "âœ… ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!\n\n"
        "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ†ĞµĞ½Ñƒ Ğ² Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°Ñ… (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 4):"
    )

async def add_promocode_step2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 2: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    try:
        price = int(update.message.text)
        if price <= 0:
            await update.message.reply_text("âŒ Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
            return
        
        context.user_data["new_promocode_price"] = price
        context.user_data['adding_promocode'] = 'waiting_quantity'
        
        await update.message.reply_text(
            "âœ… Ğ¦ĞµĞ½Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°!\n\n"
            "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² (Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾' Ğ´Ğ»Ñ Ğ½ĞµĞ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ°):"
        )
    except ValueError:
        await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")

async def add_promocode_step3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 3: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    promo_type = context.user_data.get('promo_type', 'single')
    quantity_input = update.message.text.strip().lower()
    
    if promo_type == 'batch':
        # Ğ”Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        try:
            quantity = int(quantity_input)
            if quantity <= 0:
                await update.message.reply_text("âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
                return
            
            context.user_data["new_promocode_quantity"] = quantity
            context.user_data["codes_received"] = 0
            context.user_data['adding_promocode'] = 'waiting_code_batch'
            
            await update.message.reply_text(
                f"âœ… ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾! ({quantity} Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²)\n\n"
                f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ.\n"
                f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ 1/{quantity}:"
            )
            
        except ValueError:
            await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
    else:
        # Ğ”Ğ»Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ¸ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ…
        if quantity_input == 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾' or quantity_input == 'inf' or quantity_input == 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğµ':
            quantity = -1  # -1 Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        else:
            try:
                quantity = int(quantity_input)
                if quantity < 0:
                    await update.message.reply_text("âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
                    return
            except ValueError:
                await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¸Ğ»Ğ¸ 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾'. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
                return
        
        context.user_data["new_promocode_quantity"] = quantity
        
        if promo_type == 'multi' and quantity == -1:
            # ĞœĞ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
            context.user_data['adding_promocode'] = 'waiting_code'
            await update.message.reply_text(
                "âœ… Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!\n\n"
                "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ°Ğ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: MULTI2024):"
            )
        else:
            # ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼
            context.user_data['adding_promocode'] = 'waiting_code'
            await update.message.reply_text(
                "âœ… ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!\n\n"
                "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ°Ğ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: SKIBIDI2024):"
            )

async def add_promocode_step4(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 4: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    promocode = update.message.text.strip()
    
    if not promocode:
        await update.message.reply_text("âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    context.user_data["new_promocode_code"] = promocode
    context.user_data['adding_promocode'] = 'waiting_photo'
    
    await update.message.reply_text(
        "âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½!\n\n"
        "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾):"
    )

async def add_promocode_step4_batch(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 4 Ğ´Ğ»Ñ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ°: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ"""
    promo_code = update.message.text.strip()
    total_quantity = context.user_data["new_promocode_quantity"]
    codes_received = context.user_data.get("codes_received", 0)
    
    if not promo_code:
        await update.message.reply_text("âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº
    if 'batch_codes' not in context.user_data:
        context.user_data['batch_codes'] = []
    
    context.user_data['batch_codes'].append(promo_code)
    codes_received += 1
    context.user_data["codes_received"] = codes_received
    
    if codes_received < total_quantity:
        # Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        await update.message.reply_text(
            f"âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ {codes_received}/{total_quantity} Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚!\n"
            f"ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ: {total_quantity - codes_received}\n\n"
            f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ {codes_received + 1}/{total_quantity}:"
        )
    else:
        # Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹
        context.user_data["new_promocode_code"] = context.user_data['batch_codes']
        context.user_data['adding_promocode'] = 'waiting_photo'
        
        await update.message.reply_text(
            f"âœ… Ğ’ÑĞµ {total_quantity} Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ñ‹!\n\n"
            f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾):"
        )

async def add_promocode_step5(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¨Ğ°Ğ³ 5: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ"""
    promo_type = context.user_data.get('promo_type', 'single')
    
    if update.message.text and update.message.text.lower() == 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ':
        photo_id = None
    elif update.message.photo:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ°Ğ¼Ğ¾Ğµ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾
        photo = update.message.photo[-1]
        photo_id = photo.file_id
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        try:
            photo_file = await update.message.effective_attachment.get_file()
            await photo_file.download_to_drive(f"{PROMO_PHOTOS_DIR}/{photo.file_id}.jpg")
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
    else:
        await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    if promo_type == 'batch':
        # Ğ”Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
        batch_codes = context.user_data["new_promocode_code"]
        total_quantity = len(batch_codes)
        batch_id = str(uuid4())
        
        for i, promo_code in enumerate(batch_codes, 1):
            promo_id_single = str(uuid4())
            promocodes_data[promo_id_single] = {
                "description": context.user_data["new_promocode_description"],
                "price": context.user_data["new_promocode_price"],
                "quantity": 1,  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹
                "promocode": promo_code,
                "photo_id": photo_id,
                "created_date": datetime.now().isoformat(),
                "promo_type": "batch",
                "batch_id": batch_id,
                "batch_index": i,
                "batch_total": total_quantity
            }
        
        success_text = f"âœ… *{total_quantity} Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½!*\n\n"
        success_text += (
            f"ğŸ¯ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {context.user_data.get('new_promocode_description', '')}\n"
            f"ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ·Ğ° 1 Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: {context.user_data.get('new_promocode_price', 0)} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
            f"ğŸ“¦ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {total_quantity} Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²\n"
            f"ğŸ“ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ñ‹Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞµ\n"
        )
        
    else:
        # ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promo_id = str(uuid4())
        quantity = context.user_data["new_promocode_quantity"]
        promocode = context.user_data["new_promocode_code"]
        
        promocodes_data[promo_id] = {
            "description": context.user_data["new_promocode_description"],
            "price": context.user_data["new_promocode_price"],
            "quantity": quantity,
            "promocode": promocode,
            "photo_id": photo_id,
            "created_date": datetime.now().isoformat(),
            "promo_type": promo_type
        }
        
        quantity_text = "âˆ (Ğ±ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚)" if quantity == -1 else f"{quantity}"
        success_text = f"âœ… *ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½!*\n\n"
        success_text += (
            f"ğŸ¯ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {promocodes_data[promo_id]['description']}\n"
            f"ğŸ’° Ğ¦ĞµĞ½Ğ°: {promocodes_data[promo_id]['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
            f"ğŸ“¦ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {quantity_text}\n"
            f"ğŸ“ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promocodes_data[promo_id]['promocode']}`\n"
        )
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    context.user_data.pop("new_promocode_description", None)
    context.user_data.pop("new_promocode_price", None)
    context.user_data.pop("new_promocode_quantity", None)
    context.user_data.pop("new_promocode_code", None)
    context.user_data.pop('batch_codes', None)
    context.user_data.pop('codes_received', None)
    context.user_data.pop('promo_type', None)
    context.user_data.pop('adding_promocode', None)
    
    photo_status = "âœ… Ñ Ñ„Ğ¾Ñ‚Ğ¾" if photo_id else "âŒ Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾"
    success_text += f"ğŸ–¼ï¸ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ñ„Ğ¾Ñ‚Ğ¾: {photo_status}"
    
    await update.message.reply_text(
        success_text,
        parse_mode='Markdown'
    )
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
    keyboard = [
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´", callback_data="admin_add_promocode_new")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_back")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ´Ğ°Ğ»ÑŒÑˆĞµ?", reply_markup=reply_markup)

# Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
async def admin_add_promocode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (ÑÑ‚Ğ°Ñ€Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['adding_promocode'] = 'waiting_desc'
    context.user_data['promo_type'] = 'single'  # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'Ğ¡ĞºĞµĞ±Ğ¾Ğ±'):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'Ğ¡ĞºĞµĞ±Ğ¾Ğ±'):",
            parse_mode='Markdown'
        )

async def admin_edit_promocodes(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
    query = update.callback_query
    await query.answer()
    
    if not promocodes_data:
        try:
            await query.edit_message_text("Ğ’ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="Ğ’ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."
            )
        return
    
    keyboard = []
    for promo_id, promo in promocodes_data.items():
        quantity_text = "âˆ" if promo['quantity'] == -1 else f"{promo['quantity']}"
        photo_status = "ğŸ–¼ï¸" if promo.get('photo_id') else "ğŸ“"
        promo_type = promo.get('promo_type', 'single')
        
        type_icon = "ğŸ”µ" if promo_type == 'single' else "ğŸŸ¢" if promo_type == 'multi' else "ğŸŸ¡"
        
        keyboard.append([
            InlineKeyboardButton(
                f"{type_icon} {photo_status} {promo['description']} - {promo['price']} Ñ€ĞµÑ„. (Ğ¾ÑÑ‚.: {quantity_text})",
                callback_data=f"edit_promo_{promo_id}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            "ğŸ“ *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:*",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="ğŸ“ *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:*",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def edit_promocode_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("edit_promo_", "")
    
    if promo_id not in promocodes_data:
        try:
            await query.edit_message_text("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."
            )
        return
    
    promo = promocodes_data[promo_id]
    context.user_data['editing_promocode_id'] = promo_id
    
    quantity_text = "âˆ (Ğ±ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚)" if promo['quantity'] == -1 else f"{promo['quantity']}"
    photo_status = "âœ… Ğ•ÑÑ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾" if promo.get('photo_id') else "âŒ ĞĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾"
    promo_type = promo.get('promo_type', 'single')
    type_name = "ĞĞ”Ğ˜ĞĞĞ§ĞĞ«Ğ™" if promo_type == 'single' else "ĞœĞĞĞ“ĞĞ ĞĞ—ĞĞ’Ğ«Ğ™" if promo_type == 'multi' else "ĞŸĞĞšĞ•Ğ¢ĞĞ«Ğ™"
    
    keyboard = [
        [InlineKeyboardButton("âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ", callback_data=f"change_promo_desc_{promo_id}")],
        [InlineKeyboardButton("ğŸ’° Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ", callback_data=f"change_promo_price_{promo_id}")],
        [InlineKeyboardButton("ğŸ“¦ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾", callback_data=f"change_promo_quantity_{promo_id}")],
        [InlineKeyboardButton("ğŸ“ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´", callback_data=f"change_promo_code_{promo_id}")],
        [InlineKeyboardButton("ğŸ–¼ï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾", callback_data=f"change_promo_photo_{promo_id}")],
        [InlineKeyboardButton("âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´", callback_data=f"delete_promo_{promo_id}")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_edit_promocodes")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            f"ğŸ¯ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {promo['description']}\n"
            f"ğŸ’° Ğ¦ĞµĞ½Ğ°: {promo['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
            f"ğŸ“¦ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {quantity_text}\n"
            f"ğŸ“ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promo['promocode']}`\n"
            f"ğŸ–¼ï¸ Ğ¤Ğ¾Ñ‚Ğ¾: {photo_status}\n"
            f"ğŸ“‹ Ğ¢Ğ¸Ğ¿: {type_name}\n\n"
            f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°:*\n\nğŸ¯ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {promo['description']}\nğŸ’° Ğ¦ĞµĞ½Ğ°: {promo['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\nğŸ“¦ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {quantity_text}\nğŸ“ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promo['promocode']}`\nğŸ–¼ï¸ Ğ¤Ğ¾Ñ‚Ğ¾: {photo_status}\nğŸ“‹ Ğ¢Ğ¸Ğ¿: {type_name}\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def change_promocode_description(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("change_promo_desc_", "")
    context.user_data['editing_promocode_id'] = promo_id
    context.user_data['editing_field'] = 'description'
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {promocodes_data[promo_id]['description']}\n\n"
            f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {promocodes_data[promo_id]['description']}\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:",
            parse_mode='Markdown'
        )

async def change_promocode_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("change_promo_price_", "")
    context.user_data['editing_promocode_id'] = promo_id
    context.user_data['editing_field'] = 'price'
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ†ĞµĞ½Ğ°: {promocodes_data[promo_id]['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n\n"
            f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ñ†ĞµĞ½Ñƒ:",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ†ĞµĞ½Ğ°: {promocodes_data[promo_id]['price']} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ñ†ĞµĞ½Ñƒ:",
            parse_mode='Markdown'
        )

async def change_promocode_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("change_promo_quantity_", "")
    context.user_data['editing_promocode_id'] = promo_id
    context.user_data['editing_field'] = 'quantity'
    
    current_qty = promocodes_data[promo_id]['quantity']
    current_qty_text = "âˆ (Ğ±ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚)" if current_qty == -1 else f"{current_qty}"
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {current_qty_text}\n\n"
            f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ (Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ¸Ğ»Ğ¸ 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾'):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²*\n\nĞ¢ĞµĞºÑƒÑ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: {current_qty_text}\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ (Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ¸Ğ»Ğ¸ 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾'):",
            parse_mode='Markdown'
        )

async def change_promocode_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("change_promo_code_", "")
    context.user_data['editing_promocode_id'] = promo_id
    context.user_data['editing_field'] = 'promocode'
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promocodes_data[promo_id]['promocode']}`\n\n"
            f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: `{promocodes_data[promo_id]['promocode']}`\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:",
            parse_mode='Markdown'
        )

async def change_promocode_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("change_promo_photo_", "")
    context.user_data['editing_promocode_id'] = promo_id
    context.user_data['editing_field'] = 'photo'
    
    current_photo_status = "ĞµÑÑ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾" if promocodes_data[promo_id].get('photo_id') else "Ğ½ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾"
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {current_photo_status}\n\n"
            f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ñ„Ğ¾Ñ‚Ğ¾):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°*\n\nĞ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {current_photo_status}\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ñ„Ğ¾Ñ‚Ğ¾):",
            parse_mode='Markdown'
        )

async def delete_promocode_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    query = update.callback_query
    await query.answer()
    
    promo_id = query.data.replace("delete_promo_", "")
    
    if promo_id in promocodes_data:
        promo_desc = promocodes_data[promo_id]['description']
        del promocodes_data[promo_id]
        
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        
        try:
            await query.edit_message_text(
                f"âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ '{promo_desc}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°!",
                parse_mode='Markdown'
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=f"âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ '{promo_desc}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°!",
                parse_mode='Markdown'
            )
    else:
        try:
            await query.edit_message_text("âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."
            )

async def update_promocode_description(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    promo_id = context.user_data.get('editing_promocode_id')
    if not promo_id or promo_id not in promocodes_data:
        await update.message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return
    
    new_description = update.message.text
    promocodes_data[promo_id]['description'] = new_description
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    await update.message.reply_text(
        f"âœ… ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ğ½Ğ°: *{new_description}*",
        parse_mode='Markdown'
    )
    
    context.user_data.pop('editing_promocode_id', None)
    context.user_data.pop('editing_field', None)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
    await admin_edit_promocodes_from_message(update, context)

async def update_promocode_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    promo_id = context.user_data.get('editing_promocode_id')
    if not promo_id or promo_id not in promocodes_data:
        await update.message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return
    
    try:
        new_price = int(update.message.text)
        if new_price <= 0:
            await update.message.reply_text("âŒ Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.")
            return
        
        promocodes_data[promo_id]['price'] = new_price
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        
        await update.message.reply_text(
            f"âœ… Ğ¦ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ½Ğ°: *{new_price} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*",
            parse_mode='Markdown'
        )
        
        context.user_data.pop('editing_promocode_id', None)
        context.user_data.pop('editing_field', None)
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
        await admin_edit_promocodes_from_message(update, context)
    except ValueError:
        await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾.")

async def update_promocode_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    promo_id = context.user_data.get('editing_promocode_id')
    if not promo_id or promo_id not in promocodes_data:
        await update.message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return
    
    quantity_input = update.message.text.strip().lower()
    
    if quantity_input == 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾' or quantity_input == 'inf' or quantity_input == 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğµ':
        new_quantity = -1
    else:
        try:
            new_quantity = int(quantity_input)
            if new_quantity < 0:
                await update.message.reply_text("âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼.")
                return
        except ValueError:
            await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¸Ğ»Ğ¸ 'Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾'.")
            return
    
    promocodes_data[promo_id]['quantity'] = new_quantity
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    quantity_text = "âˆ (Ğ±ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚)" if new_quantity == -1 else f"{new_quantity}"
    
    await update.message.reply_text(
        f"âœ… ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ğ½Ğ°: *{quantity_text}*",
        parse_mode='Markdown'
    )
    
    context.user_data.pop('editing_promocode_id', None)
    context.user_data.pop('editing_field', None)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
    await admin_edit_promocodes_from_message(update, context)

async def update_promocode_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    promo_id = context.user_data.get('editing_promocode_id')
    if not promo_id or promo_id not in promocodes_data:
        await update.message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return
    
    new_promocode = update.message.text.strip()
    promocodes_data[promo_id]['promocode'] = new_promocode
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    await update.message.reply_text(
        f"âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ°: `{new_promocode}`",
        parse_mode='Markdown'
    )
    
    context.user_data.pop('editing_promocode_id', None)
    context.user_data.pop('editing_field', None)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
    await admin_edit_promocodes_from_message(update, context)

async def update_promocode_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    promo_id = context.user_data.get('editing_promocode_id')
    if not promo_id or promo_id not in promocodes_data:
        await update.message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return
    
    if update.message.text and update.message.text.lower() == 'ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ':
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾
        promocodes_data[promo_id].pop('photo_id', None)
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        
        await update.message.reply_text(
            f"âœ… Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾!",
            parse_mode='Markdown'
        )
    elif update.message.photo:
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾
        photo = update.message.photo[-1]
        photo_id = photo.file_id
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        try:
            photo_file = await update.message.effective_attachment.get_file()
            await photo_file.download_to_drive(f"{PROMO_PHOTOS_DIR}/{photo.file_id}.jpg")
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
        
        promocodes_data[promo_id]['photo_id'] = photo_id
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        
        await update.message.reply_text(
            f"âœ… Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!",
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ'. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    context.user_data.pop('editing_promocode_id', None)
    context.user_data.pop('editing_field', None)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
    await admin_edit_promocodes_from_message(update, context)

async def admin_edit_promocodes_from_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ"""
    if not promocodes_data:
        await update.message.reply_text("Ğ’ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.")
        return
    
    keyboard = []
    for promo_id, promo in promocodes_data.items():
        quantity_text = "âˆ" if promo['quantity'] == -1 else f"{promo['quantity']}"
        photo_status = "ğŸ–¼ï¸" if promo.get('photo_id') else "ğŸ“"
        promo_type = promo.get('promo_type', 'single')
        
        type_icon = "ğŸ”µ" if promo_type == 'single' else "ğŸŸ¢" if promo_type == 'multi' else "ğŸŸ¡"
        
        keyboard.append([
            InlineKeyboardButton(
                f"{type_icon} {photo_status} {promo['description']} - {promo['price']} Ñ€ĞµÑ„. (Ğ¾ÑÑ‚.: {quantity_text})",
                callback_data=f"edit_promo_{promo_id}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_back")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "ğŸ“ *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:*",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def admin_manage_admins(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸"""
    query = update.callback_query
    await query.answer()
    
    admin_list_text = "ğŸ‘‘ *Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²:*\n\n"
    
    for i, admin in enumerate(admins_list, 1):
        username = escape_markdown(admin.get("username", "Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°"))
        added_by = escape_markdown(admin.get("added_by", "Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾"))
        admin_list_text += f"{i}. ID: `{admin['user_id']}` | @{username}\n"
        admin_list_text += f"   Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: {added_by}\n\n"
    
    keyboard = [
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="admin_add_admin")],
        [InlineKeyboardButton("â– Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="admin_remove_admin")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            admin_list_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=admin_list_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def admin_add_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_admin_username'] = True
    
    try:
        await query.edit_message_text(
            "ğŸ‘‘ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ username):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="ğŸ‘‘ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ username):",
            parse_mode='Markdown'
        )

async def add_admin_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    username_input = update.message.text.strip().replace('@', '')
    
    # Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    user_id_to_add = None
    found_username = None
    
    for uid, data in user_data.items():
        if data.get("username") and data["username"].lower() == username_input.lower():
            user_id_to_add = uid
            found_username = data["username"]
            break
    
    if not user_id_to_add:
        await update.message.reply_text(
            f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ @{username_input} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±Ğ¾Ñ‚Ğ°.\n"
            f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· /start"
        )
        context.user_data.pop('waiting_admin_username', None)
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼
    if is_admin(user_id_to_add):
        await update.message.reply_text(
            f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ @{found_username} ÑƒĞ¶Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼."
        )
        context.user_data.pop('waiting_admin_username', None)
        return
    
    adder_id = str(update.effective_user.id)
    adder_username = update.effective_user.username
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    admins_list.append({
        "user_id": str(user_id_to_add),
        "username": found_username,
        "added_by": f"@{adder_username}" if adder_username else f"ID: {adder_id}",
        "added_date": datetime.now().isoformat()
    })
    
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    await update.message.reply_text(
        f"âœ… ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!\n"
        f"ğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{found_username}\n"
        f"ğŸ†” ID: `{user_id_to_add}`"
    )
    
    context.user_data.pop('waiting_admin_username', None)
    
    try:
        await context.bot.send_message(
            chat_id=int(user_id_to_add),
            text=f"ğŸ‰ Ğ’Ğ°Ñ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ±Ğ¾Ñ‚Ğ° *{get_bot_name()}*!\n"
                 f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ°Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ.",
            parse_mode='Markdown'
        )
    except:
        pass

async def admin_remove_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    query = update.callback_query
    await query.answer()
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ (ĞºÑ€Ğ¾Ğ¼Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ…)
    removable_admins = [admin for admin in admins_list if admin.get("added_by") != "system"]
    
    if not removable_admins:
        try:
            await query.edit_message_text("âŒ ĞĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ).")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ)."
            )
        return
    
    keyboard = []
    for admin in removable_admins:
        username = admin.get("username", "Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°")
        keyboard.append([
            InlineKeyboardButton(
                f"@{username} (ID: {admin['user_id']})",
                callback_data=f"remove_admin_{admin['user_id']}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_manage_admins")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            "â– *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:*\n\n"
            "âš ï¸ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â– *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:*\n\nâš ï¸ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def remove_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    query = update.callback_query
    await query.answer()
    
    admin_id = query.data.replace("remove_admin_", "")
    
    # Ğ˜Ñ‰ĞµĞ¼ Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    removed = False
    for i, admin in enumerate(admins_list):
        if admin["user_id"] == admin_id and admin.get("added_by") != "system":
            admins_list.pop(i)
            DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
            removed = True
            break
    
    if removed:
        try:
            await query.edit_message_text(
                f"âœ… ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ñ ID `{admin_id}` ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½.",
                parse_mode='Markdown'
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=f"âœ… ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ñ ID `{admin_id}` ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½.",
                parse_mode='Markdown'
            )
    else:
        try:
            await query.edit_message_text(
                f"âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€.",
                parse_mode='Markdown'
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=f"âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€.",
                parse_mode='Markdown'
            )

async def admin_manage_channels(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼Ğ¸"""
    query = update.callback_query
    await query.answer()
    
    channels_text = "ğŸ“¢ *ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸:*\n\n"
    
    if not channels_list:
        channels_text += "âš ï¸ ĞĞµÑ‚ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²\n"
    else:
        for i, channel in enumerate(channels_list, 1):
            channel_title = escape_markdown(channel.get('channel_title', 'ĞšĞ°Ğ½Ğ°Ğ»'))
            added_by = escape_markdown(channel.get('added_by', 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'))
            channels_text += (
                f"{i}. *{channel_title}*\n"
                f"   Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{channel.get('channel_username', '')}\n"
                f"   ID: `{channel['channel_id']}`\n"
                f"   Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: {added_by}\n\n"
            )
    
    keyboard = [
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»", callback_data="admin_add_channel")],
        [InlineKeyboardButton("â– Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»", callback_data="admin_remove_channel")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            channels_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=channels_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def admin_add_channel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_channel'] = True
    
    try:
        await query.edit_message_text(
            "ğŸ“¢ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°*\n\n"
            "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» Ğ¸Ğ»Ğ¸ ĞµĞ³Ğ¾ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @channel_name Ğ¸Ğ»Ğ¸ https://t.me/channel_name):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="ğŸ“¢ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°*\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» Ğ¸Ğ»Ğ¸ ĞµĞ³Ğ¾ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @channel_name Ğ¸Ğ»Ğ¸ https://t.me/channel_name):",
            parse_mode='Markdown'
        )

async def add_channel_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"""
    channel_input = update.message.text.strip()
    
    # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ²
    if "t.me/" in channel_input:
        # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ https:// Ğ¸ Ñ‚.Ğ´.
        channel_input = channel_input.replace("https://", "").replace("http://", "")
        if "t.me/" in channel_input:
            channel_username = channel_input.split("t.me/")[-1].split("?")[0].strip("/")
        else:
            channel_username = channel_input.strip("/")
    elif channel_input.startswith("@"):
        channel_username = channel_input[1:]
    else:
        channel_username = channel_input
    
    try:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğµ
        chat = await context.bot.get_chat(f"@{channel_username}")
        
        if chat.type not in ["channel", "group", "supergroup"]:
            await update.message.reply_text("âŒ Ğ£ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ¹.")
            context.user_data.pop('waiting_channel', None)
            return
        
        channel_id = str(chat.id)
        channel_title = chat.title
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ (Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²)
        bot_is_admin = False
        try:
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±Ğ¾Ñ‚Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ
            bot_member = await context.bot.get_chat_member(chat.id, context.bot.id)
            if bot_member.status in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]:
                bot_is_admin = True
                logger.info(f"Ğ‘Ğ¾Ñ‚ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ° {channel_id}")
            else:
                logger.warning(f"Ğ‘Ğ¾Ñ‚ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ° {channel_id}. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {bot_member.status}")
        except Exception as e:
            logger.warning(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ±Ğ¾Ñ‚Ğ° Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ {channel_id}: {e}")
            bot_is_admin = False
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğ½Ğ°Ğ»
        adder_id = str(update.effective_user.id)
        adder_username = update.effective_user.username
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ ÑÑ‚Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ»
        if any(channel["channel_id"] == channel_id for channel in channels_list):
            await update.message.reply_text("âŒ Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ» ÑƒĞ¶Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ….")
            context.user_data.pop('waiting_channel', None)
            return
        
        channels_list.append({
            "channel_id": channel_id,
            "channel_username": channel_username,
            "channel_title": channel_title,
            "added_by": f"@{adder_username}" if adder_username else f"ID: {adder_id}",
            "added_date": datetime.now().isoformat(),
            "bot_is_admin": bot_is_admin
        })
        
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        
        admin_status = "âœ… Ğ‘Ğ¾Ñ‚ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼" if bot_is_admin else "âš ï¸ Ğ‘Ğ¾Ñ‚ ĞĞ• ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ)"
        
        safe_channel_title = escape_markdown(channel_title)
        
        await update.message.reply_text(
            f"âœ… ĞšĞ°Ğ½Ğ°Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!\n\n"
            f"ğŸ“¢ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: *{safe_channel_title}*\n"
            f"ğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{channel_username}\n"
            f"ğŸ†” ID: `{channel_id}`\n"
            f"{admin_status}\n\n"
            f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°.",
            parse_mode='Markdown'
        )
        
        context.user_data.pop('waiting_channel', None)
        
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°: {e}")
        await update.message.reply_text(
            "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ».\n"
            "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾:\n"
            "1. ĞšĞ°Ğ½Ğ°Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹\n"
            "2. Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»\n"
            "3. Ğ’Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ»Ğ¸ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ Ğ¸Ğ»Ğ¸ ÑÑÑ‹Ğ»ĞºÑƒ\n\n"
            f"ĞÑˆĞ¸Ğ±ĞºĞ°: {str(e)}"
        )
        context.user_data.pop('waiting_channel', None)

async def admin_remove_channel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"""
    query = update.callback_query
    await query.answer()
    
    if not channels_list:
        try:
            await query.edit_message_text("âŒ ĞĞµÑ‚ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ.")
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞĞµÑ‚ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ."
            )
        return
    
    keyboard = []
    for channel in channels_list:
        channel_title = channel.get('channel_title', 'ĞšĞ°Ğ½Ğ°Ğ»')
        channel_username = channel.get('channel_username', '')
        bot_admin_status = "âœ…" if channel.get('bot_is_admin', False) else "âŒ"
        
        keyboard.append([
            InlineKeyboardButton(
                f"{bot_admin_status} {channel_title} (@{channel_username})",
                callback_data=f"remove_channel_{channel['channel_id']}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_manage_channels")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            "â– *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:*\n"
            "âœ… - Ğ±Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€, âŒ - Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â– *Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:*\nâœ… - Ğ±Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€, âŒ - Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def remove_channel_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"""
    query = update.callback_query
    await query.answer()
    
    channel_id = query.data.replace("remove_channel_", "")
    
    # Ğ˜Ñ‰ĞµĞ¼ ĞºĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
    channel_info = None
    for i, channel in enumerate(channels_list):
        if channel["channel_id"] == channel_id:
            channel_info = channel
            channels_list.pop(i)
            DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
            break
    
    if channel_info:
        safe_channel_title = escape_markdown(channel_info.get('channel_title', 'ĞšĞ°Ğ½Ğ°Ğ»'))
        
        try:
            await query.edit_message_text(
                f"âœ… ĞšĞ°Ğ½Ğ°Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½!\n\n"
                f"ğŸ“¢ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: *{safe_channel_title}*\n"
                f"ğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{channel_info.get('channel_username', '')}\n\n"
                f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ».",
                parse_mode='Markdown'
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=f"âœ… ĞšĞ°Ğ½Ğ°Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½!\n\nğŸ“¢ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: *{safe_channel_title}*\nğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{channel_info.get('channel_username', '')}\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ».",
                parse_mode='Markdown'
            )
    else:
        try:
            await query.edit_message_text(
                "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ».",
                parse_mode='Markdown'
            )
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ».",
                parse_mode='Markdown'
            )

async def admin_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞºÑÑ‚"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_broadcast'] = True
    
    try:
        await query.edit_message_text(
            "ğŸ“¢ *Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸*\n\n"
            "ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ:\n"
            "â€¢ Ğ¢ĞµĞºÑÑ‚ - Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸\n"
            "â€¢ Ğ¤Ğ¾Ñ‚Ğ¾ - Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ñ Ñ„Ğ¾Ñ‚Ğ¾ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ)\n\n"
            "â„¹ï¸ Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Markdown\n"
            "âš ï¸ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ±Ğ¾Ñ‚Ğ°",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="ğŸ“¢ *Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸*\n\nĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ:\nâ€¢ Ğ¢ĞµĞºÑÑ‚ - Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸\nâ€¢ Ğ¤Ğ¾Ñ‚Ğ¾ - Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ñ Ñ„Ğ¾Ñ‚Ğ¾ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ)\n\nâ„¹ï¸ Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Markdown\nâš ï¸ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ±Ğ¾Ñ‚Ğ°",
            parse_mode='Markdown'
        )

async def broadcast_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ - Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ‚Ğ¸Ğ¿"""
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾
    if update.message.photo:
        # Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ñ Ñ„Ğ¾Ñ‚Ğ¾
        photo = update.message.photo[-1]
        caption = update.message.caption or ""
        
        context.user_data['broadcast_photo_id'] = photo.file_id
        context.user_data['broadcast_caption'] = caption
        context.user_data['broadcast_type'] = 'photo'
        context.user_data.pop('waiting_broadcast', None)
        
        keyboard = [
            [InlineKeyboardButton("âœ… Ğ”Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ", callback_data="confirm_broadcast")],
            [InlineKeyboardButton("âŒ ĞĞµÑ‚, Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ", callback_data="cancel_broadcast")]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if caption:
            preview_text = f"ğŸ–¼ï¸ *ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ñ Ñ„Ğ¾Ñ‚Ğ¾:*\n\nĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ: {caption}\n\n"
        else:
            preview_text = "ğŸ–¼ï¸ *ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ñ Ñ„Ğ¾Ñ‚Ğ¾:*\n\n(Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸)\n\n"
        
        preview_text += f"*ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ Ñ„Ğ¾Ñ‚Ğ¾ Ğ²ÑĞµĞ¼ {len(user_data)} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼?*"
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ¾Ñ‚Ğ¾)
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=preview_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
        
    else:
        # Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ°
        message_text = update.message.text
        
        if not message_text:
            await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ»Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸.")
            return
        
        context.user_data['broadcast_message'] = message_text
        context.user_data['broadcast_type'] = 'text'
        context.user_data.pop('waiting_broadcast', None)
        
        keyboard = [
            [InlineKeyboardButton("âœ… Ğ”Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ", callback_data="confirm_broadcast")],
            [InlineKeyboardButton("âŒ ĞĞµÑ‚, Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ", callback_data="cancel_broadcast")]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            f"ğŸ“¢ *ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸:*\n\n"
            f"{message_text}\n\n"
            f"*ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ¼ {len(user_data)} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼?*",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def confirm_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸"""
    query = update.callback_query
    await query.answer()
    
    broadcast_type = context.user_data.get('broadcast_type', 'text')
    
    # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾
    try:
        if broadcast_type == 'text':
            await query.edit_message_text("ğŸ“¤ *ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²ÑƒÑ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ...*", parse_mode='Markdown')
        elif broadcast_type == 'photo':
            await query.edit_message_text("ğŸ“¤ *ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ Ñ Ñ„Ğ¾Ñ‚Ğ¾...*", parse_mode='Markdown')
    except Exception as e:
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        logger.warning(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {e}")
        if broadcast_type == 'text':
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="ğŸ“¤ *ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²ÑƒÑ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ...*",
                parse_mode='Markdown'
            )
        elif broadcast_type == 'photo':
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="ğŸ“¤ *ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ Ñ Ñ„Ğ¾Ñ‚Ğ¾...*",
                parse_mode='Markdown'
            )
    
    if broadcast_type == 'text':
        message_text = context.user_data.get('broadcast_message', '')
        
        if not message_text:
            try:
                await query.edit_message_text("âŒ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
            except:
                await context.bot.send_message(
                    chat_id=query.message.chat_id,
                    text="âŒ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾."
                )
            return
        
        successful = 0
        failed = 0
        total = len(user_data)
        
        for i, (user_id, _) in enumerate(user_data.items(), 1):
            try:
                await context.bot.send_message(
                    chat_id=int(user_id),
                    text=message_text,
                    parse_mode='Markdown'
                )
                successful += 1
                
                if i % 20 == 0:
                    await asyncio.sleep(1)
                    
            except Exception as e:
                failed += 1
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}: {e}")
        
        context.user_data.pop('broadcast_message', None)
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        result_text = (
            f"âœ… *Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!*\n\n"
            f"ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\n"
            f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {total}\n"
            f"â€¢ Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {successful}\n"
            f"â€¢ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ: {failed}"
        )
        
        try:
            await query.edit_message_text(result_text, parse_mode='Markdown')
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=result_text,
                parse_mode='Markdown'
            )
        
    elif broadcast_type == 'photo':
        photo_id = context.user_data.get('broadcast_photo_id')
        caption = context.user_data.get('broadcast_caption', '')
        
        if not photo_id:
            try:
                await query.edit_message_text("âŒ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
            except:
                await context.bot.send_message(
                    chat_id=query.message.chat_id,
                    text="âŒ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾."
                )
            return
        
        successful = 0
        failed = 0
        total = len(user_data)
        
        for i, (user_id, _) in enumerate(user_data.items(), 1):
            try:
                await context.bot.send_photo(
                    chat_id=int(user_id),
                    photo=photo_id,
                    caption=caption if caption else None,
                    parse_mode='Markdown' if caption else None
                )
                successful += 1
                
                if i % 20 == 0:
                    await asyncio.sleep(1)
                    
            except Exception as e:
                failed += 1
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}: {e}")
        
        context.user_data.pop('broadcast_photo_id', None)
        context.user_data.pop('broadcast_caption', None)
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        result_text = (
            f"âœ… *Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!*\n\n"
            f"ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\n"
            f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {total}\n"
            f"â€¢ Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {successful}\n"
            f"â€¢ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ: {failed}"
        )
        
        try:
            await query.edit_message_text(result_text, parse_mode='Markdown')
        except:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=result_text,
                parse_mode='Markdown'
            )
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    context.user_data.pop('broadcast_type', None)

async def cancel_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸"""
    query = update.callback_query
    await query.answer()
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    context.user_data.pop('broadcast_message', None)
    context.user_data.pop('broadcast_photo_id', None)
    context.user_data.pop('broadcast_caption', None)
    context.user_data.pop('broadcast_type', None)
    context.user_data.pop('waiting_broadcast', None)
    
    try:
        await query.edit_message_text("âŒ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.")
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="âŒ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°."
        )

async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ±Ğ¾Ñ‚Ğ° (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)"""
    query = update.callback_query
    await query.answer()
    
    # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
    visible_users = {uid: data for uid, data in user_data.items() if not is_hidden_user(uid)}
    hidden_users = {uid: data for uid, data in user_data.items() if is_hidden_user(uid)}
    
    total_users = len(visible_users)
    total_referrals = sum(len(user["referrals"]) for user in visible_users.values())
    active_users = sum(1 for user in visible_users.values() if len(user["referrals"]) > 0)
    total_balance = sum(user.get("balance", 0) for user in visible_users.values())
    
    # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    hidden_referrals = 0
    hidden_balance = 0
    for user_id, data in hidden_users.items():
        hidden_referrals += data.get("total_referrals_count", 0)
        hidden_balance += data.get("balance", 0)
    
    # Ğ¢Ğ¾Ğ¿ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ¾Ğ² (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
    top_referrers = []
    for uid, data in visible_users.items():
        if not is_admin(uid):  # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²
            referrals_count = len(data["referrals"])
            if referrals_count > 0:
                username = data.get("username", f"User {uid}")
                if username and username.startswith("User ID:"):
                    display_name = f"ID: {uid}"
                else:
                    display_name = f"@{username}" if username else f"ID: {uid}"
                
                referral_network = data.get("referral_network", referrals_count)
                balance = data.get("balance", 0)
                
                top_referrers.append({
                    "user_id": uid,
                    "username": display_name,
                    "referrals_count": referrals_count,
                    "referral_network": referral_network,
                    "balance": balance
                })
    
    top_referrers.sort(key=lambda x: x["referrals_count"], reverse=True)
    
    # ĞŸĞ¾Ğ´ÑÑ‡ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 30 Ğ´Ğ½ĞµĞ¹
    month_ago = datetime.now().timestamp() - (30 * 24 * 60 * 60)
    new_users_month = 0
    for user in visible_users.values():
        try:
            joined_date = datetime.fromisoformat(user.get("joined_date", ""))
            if joined_date.timestamp() > month_ago:
                new_users_month += 1
        except:
            pass
    
    # ĞŸĞ¾Ğ´ÑÑ‡ĞµÑ‚ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº
    total_purchases = 0
    for user in visible_users.values():
        total_purchases += len(user.get("purchased_promocodes", []))
    
    stats_text = (
        f"ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°*\n\n"
        f"ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {total_users} (ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ…: {len(hidden_users)})\n"
        f"ğŸ“ˆ ĞĞ¾Ğ²Ñ‹Ñ… Ğ·Ğ° 30 Ğ´Ğ½ĞµĞ¹: {new_users_month}\n"
        f"ğŸ“ˆ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {active_users}\n"
        f"ğŸ”— Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {total_referrals:,}\n"
        f"ğŸ”— Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {hidden_referrals:,}\n"
        f"ğŸ”— Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (Ğ²ÑĞµÑ…): {total_referrals + hidden_referrals:,}\n"
        f"ğŸ’° ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {total_balance:,}\n"
        f"ğŸ’° Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {hidden_balance:,}\n"
        f"ğŸ›’ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº: {total_purchases}\n"
        f"ğŸ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}\n"
        f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²: {len(admins_list)}\n"
        f"ğŸ“¢ ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}\n\n"
        f"ğŸ† *Ğ¢Ğ¾Ğ¿ 10 Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ¾Ğ² (Ğ±ĞµĞ· Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ…):*\n"
    )
    
    if top_referrers:
        for i, user in enumerate(top_referrers[:10], 1):
            medal = ""
            if i == 1:
                medal = "ğŸ¥‡ "
            elif i == 2:
                medal = "ğŸ¥ˆ "
            elif i == 3:
                medal = "ğŸ¥‰ "
            
            stats_text += f"{medal}{i}. {user['username']}\n"
            stats_text += f"   â”” ĞŸÑ€ÑĞ¼Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {user['referrals_count']:,}\n"
            stats_text += f"   â”” Ğ¡ĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: {user['referral_network']:,}\n"
            stats_text += f"   â”” Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
    else:
        stats_text += "ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ¾Ğ²\n"
    
    keyboard = [[InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(stats_text, parse_mode='Markdown', reply_markup=reply_markup)
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=stats_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def admin_change_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_bot_name'] = True
    
    try:
        await query.edit_message_text(
            f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°*\n\n"
            f"Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: *{escape_markdown(get_bot_name())}*\n\n"
            f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°:",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=f"âœï¸ *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°*\n\nĞ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: *{escape_markdown(get_bot_name())}*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°:",
            parse_mode='Markdown'
        )

async def change_bot_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°"""
    new_name = update.message.text.strip()
    
    if not new_name:
        await update.message.reply_text("âŒ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.")
        context.user_data.pop('waiting_bot_name', None)
        return
    
    bot_config["bot_name"] = new_name
    DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
    
    await update.message.reply_text(
        f"âœ… ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ğ½Ğ°: *{escape_markdown(new_name)}*",
        parse_mode='Markdown'
    )
    
    context.user_data.pop('waiting_bot_name', None)

async def admin_add_referrals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_add_referrals'] = True
    
    try:
        await query.edit_message_text(
            "â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ğ¸Ğ· ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ²:\n"
            "1. Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n"
            "2. ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)\n\n"
            "Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â• *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ğ¸Ğ· ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ²:\n1. Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n2. ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)\n\nĞ—Ğ°Ñ‚ĞµĞ¼ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾):",
            parse_mode='Markdown'
        )

async def admin_remove_referrals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞÑ‚Ğ½ÑÑ‚Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    query = update.callback_query
    await query.answer()
    
    context.user_data['waiting_remove_referrals'] = True
    
    try:
        await query.edit_message_text(
            "â– *ĞÑ‚Ğ½ÑÑ‚Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n\n"
            "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ğ¸Ğ· ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ²:\n"
            "1. Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n"
            "2. ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)\n\n"
            "Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ½ÑÑ‚Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾):",
            parse_mode='Markdown'
        )
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="â– *ĞÑ‚Ğ½ÑÑ‚Ğ¸Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ğ¸Ğ· ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ²:\n1. Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n2. ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)\n\nĞ—Ğ°Ñ‚ĞµĞ¼ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ½ÑÑ‚Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾):",
            parse_mode='Markdown'
        )

async def process_add_referrals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²"""
    text = update.message.text.strip()
    
    if 'user_identifier' not in context.user_data:
        # ĞŸĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ - Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        user_identifier = text
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°
        if user_identifier.startswith('@'):
            # Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼
            username = user_identifier[1:].lower()
            user_id = None
            
            for uid, data in user_data.items():
                if data.get("username") and data["username"].lower() == username:
                    user_id = uid
                    break
            
            if not user_id:
                await update.message.reply_text(
                    f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ @{username} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±Ğ¾Ñ‚Ğ°.\n"
                    f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· /start"
                )
                context.user_data.pop('waiting_add_referrals', None)
                return
            
            context.user_data['user_identifier'] = user_id
            context.user_data['username'] = username
            
        elif user_identifier.isdigit():
            # ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            user_id = user_identifier
            
            if user_id not in user_data:
                await update.message.reply_text(
                    f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ ID {user_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±Ğ¾Ñ‚Ğ°.\n"
                    f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· /start"
                )
                context.user_data.pop('waiting_add_referrals', None)
                return
            
            context.user_data['user_identifier'] = user_id
            context.user_data['username'] = user_data[user_id].get('username', 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°')
            
        else:
            # ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
            await update.message.reply_text(
                "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ:\n"
                "â€¢ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n"
                "â€¢ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)"
            )
            return
        
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ escape_markdown Ğ´Ğ»Ñ username Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹
        safe_username = escape_markdown(context.user_data['username']) if context.user_data['username'] else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
        
        await update.message.reply_text(
            f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!\n"
            f"ğŸ‘¤ ID: `{context.user_data['user_identifier']}`\n"
            f"ğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{safe_username}\n\n"
            f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾):"
        )
        
    else:
        # Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
        try:
            referrals_to_add = int(text)
            if referrals_to_add <= 0:
                await update.message.reply_text("âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
                return
            
            user_id = context.user_data['user_identifier']
            username = context.user_data['username']
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
            current_total = user_data[user_id].get("total_referrals_count", 0)
            current_balance = user_data[user_id].get("balance", 0)
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            user_data[user_id]["total_referrals_count"] = current_total + referrals_to_add
            user_data[user_id]["balance"] = current_balance + referrals_to_add
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            await update_referral_network(user_id)
            
            DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
            
            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            try:
                await context.bot.send_message(
                    chat_id=int(user_id),
                    text=f"ğŸ‰ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ» Ğ²Ğ°Ğ¼ *{referrals_to_add}* Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²!\n\n"
                         f"ğŸ“Š Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ²Ğ°Ñ:\n"
                         f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{user_data[user_id]['total_referrals_count']:,}*\n"
                         f"â€¢ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{user_data[user_id]['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*",
                    parse_mode='Markdown'
                )
            except:
                pass
            
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ escape_markdown Ğ´Ğ»Ñ username Ğ² Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
            safe_username = escape_markdown(username) if username else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
            
            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
            await update.message.reply_text(
                f"âœ… Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹!\n\n"
                f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: @{safe_username} (ID: `{user_id}`)\n"
                f"â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: *{referrals_to_add}* Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
                f"ğŸ“Š Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:\n"
                f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{user_data[user_id]['total_referrals_count']:,}*\n"
                f"â€¢ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{user_data[user_id]['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*",
                parse_mode='Markdown'
            )
            
            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            context.user_data.pop('waiting_add_referrals', None)
            context.user_data.pop('user_identifier', None)
            context.user_data.pop('username', None)
            
        except ValueError:
            await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾.")

async def process_remove_referrals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ñ‚Ğ½ÑÑ‚Ğ¸Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²"""
    text = update.message.text.strip()
    
    if 'user_identifier' not in context.user_data:
        # ĞŸĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ - Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        user_identifier = text
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°
        if user_identifier.startswith('@'):
            # Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼
            username = user_identifier[1:].lower()
            user_id = None
            
            for uid, data in user_data.items():
                if data.get("username") and data["username"].lower() == username:
                    user_id = uid
                    break
            
            if not user_id:
                await update.message.reply_text(
                    f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ @{username} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±Ğ¾Ñ‚Ğ°.\n"
                    f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· /start"
                )
                context.user_data.pop('waiting_remove_referrals', None)
                return
            
            context.user_data['user_identifier'] = user_id
            context.user_data['username'] = username
            
        elif user_identifier.isdigit():
            # ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            user_id = user_identifier
            
            if user_id not in user_data:
                await update.message.reply_text(
                    f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ ID {user_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±Ğ¾Ñ‚Ğ°.\n"
                    f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· /start"
                )
                context.user_data.pop('waiting_remove_referrals', None)
                return
            
            context.user_data['user_identifier'] = user_id
            context.user_data['username'] = user_data[user_id].get('username', 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°')
            
        else:
            # ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
            await update.message.reply_text(
                "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ:\n"
                "â€¢ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: @username)\n"
                "â€¢ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1234567890)"
            )
            return
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
        current_total = user_data[user_id].get("total_referrals_count", 0)
        current_balance = user_data[user_id].get("balance", 0)
        
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ escape_markdown Ğ´Ğ»Ñ username Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹
        safe_username = escape_markdown(context.user_data['username']) if context.user_data['username'] else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
        
        await update.message.reply_text(
            f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!\n"
            f"ğŸ‘¤ ID: `{context.user_data['user_identifier']}`\n"
            f"ğŸ‘¤ Ğ®Ğ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼: @{safe_username}\n"
            f"ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:\n"
            f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{current_total:,}*\n"
            f"â€¢ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{current_balance:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*\n\n"
            f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ½ÑÑ‚Ğ¸Ñ (Ñ†ĞµĞ»Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°):"
        )
        
    else:
        # Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
        try:
            referrals_to_remove = int(text)
            if referrals_to_remove <= 0:
                await update.message.reply_text("âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
                return
            
            user_id = context.user_data['user_identifier']
            username = context.user_data['username']
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
            current_total = user_data[user_id].get("total_referrals_count", 0)
            current_balance = user_data[user_id].get("balance", 0)
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ»Ğ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            if referrals_to_remove > current_balance:
                await update.message.reply_text(
                    f"âŒ ĞĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ½ÑÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ², Ñ‡ĞµĞ¼ ĞµÑÑ‚ÑŒ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.\n"
                    f"Ğ£ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: *{current_balance}* Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
                    f"Ğ’Ñ‹ Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ĞµÑÑŒ Ğ¾Ñ‚Ğ½ÑÑ‚ÑŒ: *{referrals_to_remove}*"
                )
                return
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            new_total = max(0, current_total - referrals_to_remove)
            new_balance = max(0, current_balance - referrals_to_remove)
            
            user_data[user_id]["total_referrals_count"] = new_total
            user_data[user_id]["balance"] = new_balance
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²
            await update_referral_network(user_id)
            
            DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
            
            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            try:
                await context.bot.send_message(
                    chat_id=int(user_id),
                    text=f"âš ï¸ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¾Ñ‚Ğ½ÑĞ» Ñƒ Ğ²Ğ°Ñ *{referrals_to_remove}* Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ².\n\n"
                         f"ğŸ“Š Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ²Ğ°Ñ:\n"
                         f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{user_data[user_id]['total_referrals_count']:,}*\n"
                         f"â€¢ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{user_data[user_id]['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*",
                    parse_mode='Markdown'
                )
            except:
                pass
            
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ escape_markdown Ğ´Ğ»Ñ username Ğ² Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹
            safe_username = escape_markdown(username) if username else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
            
            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
            await update.message.reply_text(
                f"âœ… Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ½ÑÑ‚Ñ‹!\n\n"
                f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: @{safe_username} (ID: `{user_id}`)\n"
                f"â– ĞÑ‚Ğ½ÑÑ‚Ğ¾: *{referrals_to_remove}* Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²\n"
                f"ğŸ“Š Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:\n"
                f"â€¢ Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: *{user_data[user_id]['total_referrals_count']:,}*\n"
                f"â€¢ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: *{user_data[user_id]['balance']:,} Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*",
                parse_mode='Markdown'
            )
            
            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            context.user_data.pop('waiting_remove_referrals', None)
            context.user_data.pop('user_identifier', None)
            context.user_data.pop('username', None)
            
        except ValueError:
            await update.message.reply_text("âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾.")

async def admin_back(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸"""
    query = update.callback_query
    await query.answer()
    
    await show_admin_panel_from_callback(update, context)

async def show_admin_panel_from_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¸Ğ· callback"""
    query = update.callback_query
    
    keyboard = [
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´", callback_data="admin_add_promocode_new")],
        [InlineKeyboardButton("ğŸ“ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹", callback_data="admin_edit_promocodes")],
        [InlineKeyboardButton("ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°", callback_data="admin_stats")],
        [InlineKeyboardButton("ğŸ‘‘ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²", callback_data="admin_manage_admins")],
        [InlineKeyboardButton("ğŸ“¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼Ğ¸", callback_data="admin_manage_channels")],
        [InlineKeyboardButton("ğŸ“¢ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ", callback_data="admin_broadcast")],
        [InlineKeyboardButton("âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°", callback_data="admin_change_name")],
        [InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹", callback_data="admin_add_referrals")],
        [InlineKeyboardButton("â– ĞÑ‚Ğ½ÑÑ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹", callback_data="admin_remove_referrals")],
        [InlineKeyboardButton("âŒ Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_close")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    bot_name = get_bot_name()
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ username Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹
    username = escape_markdown(update.effective_user.username) if update.effective_user.username else 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'
    
    admin_text = (
        f"ğŸ® *ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ*\n\n"
        f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€: @{username}\n"
        f"ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {len(user_data)}\n"
        f"ğŸ›’ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}\n"
        f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²: {len(admins_list)}\n"
        f"ğŸ“¢ ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}"
    )
    
    try:
        await query.edit_message_text(admin_text, parse_mode='Markdown', reply_markup=reply_markup)
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸: {e}")
        # Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ñ Markdown, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ· Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ¸
        fallback_text = (
            f"ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ\n\n"
            f"ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€: @{update.effective_user.username or 'Ğ±ĞµĞ· ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'}\n"
            f"Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {len(user_data)}\n"
            f"ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}\n"
            f"ĞĞ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²: {len(admins_list)}\n"
            f"ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}"
        )
        await query.edit_message_text(
            fallback_text,
            reply_markup=reply_markup
        )

async def admin_close(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"""
    query = update.callback_query
    await query.answer()
    
    try:
        await query.edit_message_text("âœ… ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°.")
    except:
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text="âœ… ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°."
        )

async def check_subscription_test(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸"""
    user_id = update.effective_user.id
    is_subscribed, not_subscribed = await check_subscription(user_id, context)
    
    if is_subscribed:
        await update.message.reply_text("âœ… Ğ’Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ½Ğ° Ğ²ÑĞµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹!")
    else:
        await update.message.reply_text(f"âŒ Ğ’Ñ‹ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ½Ğ° {len(not_subscribed)} ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²:")
        for channel in not_subscribed:
            await update.message.reply_text(f"- {channel.get('channel_title', 'ĞšĞ°Ğ½Ğ°Ğ»')} (ID: {channel.get('channel_id')})")

async def callback_error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ…"""
    query = update.callback_query
    
    if query:
        try:
            await query.answer()
            await query.edit_message_text(
                "âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ· Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
            )
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² callback_error_handler: {e}")
            try:
                await context.bot.send_message(
                    chat_id=query.message.chat_id,
                    text="âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ· Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
                )
            except:
                pass

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº"""
    logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ°: {context.error}", exc_info=True)
    if update and update.effective_message:
        try:
            await update.effective_message.reply_text("âš ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        except:
            pass

def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°"""
    application = Application.builder().token(BOT_TOKEN).build()
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start
    application.add_handler(CommandHandler("start", start))
    
    # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    application.add_handler(CommandHandler("check", check_subscription_test))
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ„Ğ¾Ñ‚Ğ¾ (Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²)
    application.add_handler(MessageHandler(filters.PHOTO, handle_message))
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    application.add_handler(CallbackQueryHandler(buy_promocode_callback, pattern="^buy_promo_"))
    application.add_handler(CallbackQueryHandler(shop_page_callback, pattern="^shop_page_"))
    application.add_handler(CallbackQueryHandler(check_subscription_callback, pattern="^check_subs_"))
    application.add_handler(CallbackQueryHandler(profile_callback, pattern="^profile_"))
    application.add_handler(CallbackQueryHandler(show_admin_panel, pattern="^admin_panel$"))
    
    # ĞĞĞ’Ğ«Ğ• ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ”Ğ›Ğ¯ Ğ¢Ğ˜ĞŸĞĞ’ ĞŸĞ ĞĞœĞĞšĞĞ”ĞĞ’
    application.add_handler(CallbackQueryHandler(admin_add_promocode_new, pattern="^admin_add_promocode_new$"))
    application.add_handler(CallbackQueryHandler(promo_type_single_callback, pattern="^promo_type_single$"))
    application.add_handler(CallbackQueryHandler(promo_type_multi_callback, pattern="^promo_type_multi$"))
    application.add_handler(CallbackQueryHandler(promo_type_batch_callback, pattern="^promo_type_batch$"))
    
    # Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    application.add_handler(CallbackQueryHandler(admin_add_promocode, pattern="^admin_add_promocode$"))
    
    application.add_handler(CallbackQueryHandler(admin_edit_promocodes, pattern="^admin_edit_promocodes$"))
    application.add_handler(CallbackQueryHandler(admin_stats, pattern="^admin_stats$"))
    application.add_handler(CallbackQueryHandler(admin_manage_admins, pattern="^admin_manage_admins$"))
    application.add_handler(CallbackQueryHandler(admin_manage_channels, pattern="^admin_manage_channels$"))
    application.add_handler(CallbackQueryHandler(admin_add_admin, pattern="^admin_add_admin$"))
    application.add_handler(CallbackQueryHandler(admin_remove_admin, pattern="^admin_remove_admin$"))
    application.add_handler(CallbackQueryHandler(admin_add_channel, pattern="^admin_add_channel$"))
    application.add_handler(CallbackQueryHandler(admin_remove_channel, pattern="^admin_remove_channel$"))
    application.add_handler(CallbackQueryHandler(remove_admin_callback, pattern="^remove_admin_"))
    application.add_handler(CallbackQueryHandler(remove_channel_callback, pattern="^remove_channel_"))
    application.add_handler(CallbackQueryHandler(admin_broadcast, pattern="^admin_broadcast$"))
    application.add_handler(CallbackQueryHandler(confirm_broadcast, pattern="^confirm_broadcast$"))
    application.add_handler(CallbackQueryHandler(cancel_broadcast, pattern="^cancel_broadcast$"))
    application.add_handler(CallbackQueryHandler(admin_change_name, pattern="^admin_change_name$"))
    application.add_handler(CallbackQueryHandler(admin_add_referrals, pattern="^admin_add_referrals$"))
    application.add_handler(CallbackQueryHandler(admin_remove_referrals, pattern="^admin_remove_referrals$"))
    application.add_handler(CallbackQueryHandler(admin_back, pattern="^admin_back$"))
    application.add_handler(CallbackQueryHandler(admin_close, pattern="^admin_close$"))
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
    application.add_handler(CallbackQueryHandler(edit_promocode_callback, pattern="^edit_promo_"))
    application.add_handler(CallbackQueryHandler(change_promocode_description, pattern="^change_promo_desc_"))
    application.add_handler(CallbackQueryHandler(change_promocode_price, pattern="^change_promo_price_"))
    application.add_handler(CallbackQueryHandler(change_promocode_quantity, pattern="^change_promo_quantity_"))
    application.add_handler(CallbackQueryHandler(change_promocode_code, pattern="^change_promo_code_"))
    application.add_handler(CallbackQueryHandler(change_promocode_photo, pattern="^change_promo_photo_"))
    application.add_handler(CallbackQueryHandler(delete_promocode_callback, pattern="^delete_promo_"))
    
    # ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    application.add_handler(CallbackQueryHandler(callback_error_handler))
    
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    application.add_error_handler(error_handler)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
    if HIDDEN_USER_ID not in user_data:
        user_data[HIDDEN_USER_ID] = {
            "referrals": [],
            "balance": 15000,
            "purchased_promocodes": [],
            "purchased_codes_details": {},
            "joined_date": datetime.now().isoformat(),
            "username": "PohyiNaDengi",
            "subscribed": True,
            "total_referrals_count": 15000,
            "referral_network": 15000,
            "hidden": True
        }
        DataStorage.save_data(user_data, promocodes_data, bot_config, admins_list, channels_list)
        logger.info(f"Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {HIDDEN_USER_ID} Ñ 15000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼")
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
    print(f"ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½! ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: {get_bot_name()}")
    print(f"ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹: {[admin['user_id'] for admin in admins_list]}")
    print(f"ğŸ“Š Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² Ğ±Ğ°Ğ·Ğµ: {len(user_data)} (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ…)")
    print(f"ğŸ›’ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ: {len(promocodes_data)}")
    print(f"ğŸ“¢ ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²: {len(channels_list)}")
    print(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¾Ğ¹")
    print(f"âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° (ÑƒĞ±Ñ€Ğ°Ğ½Ñ‹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸)")
    print(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {HIDDEN_USER_ID} Ñ 15000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²")
    print(f"âœ… Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½ Ğ¸Ğ· Ñ‚Ğ¾Ğ¿Ğ¾Ğ² Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸")
    print(f"âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¼ĞµĞ½ÑÑˆĞºĞ° Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ 'ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²'")
    print(f"âœ… Ğ’ÑĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚")
    print(f"âœ… Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ 15,000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ")
    print(f"ğŸ›’ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ*")
    print(f"ğŸ’° *Ğ¦ĞµĞ½Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· .0 (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 4 Ñ€ĞµÑ„.)*")
    print(f"ğŸ“¸ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ÑÑ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾ Ğº Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼*")
    print(f"ğŸ“„ *ĞŸĞ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ*")
    print(f"ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ²Ğ½Ğ¸Ğ·Ñƒ*")
    print(f"ğŸ›’ *ĞšĞ½Ğ¾Ğ¿ĞºĞ° 'ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ' ĞºĞ°Ğº Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ*")
    print(f"â—€ï¸ â–¶ï¸ *ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ 'ĞĞ°Ğ·Ğ°Ğ´'/'Ğ’Ğ¿ĞµÑ€ĞµĞ´'*")
    print(f"ğŸ“Š *ĞĞ¾Ğ¼ĞµÑ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° X/Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾*")
    print(f"â•â– *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ/Ğ¾Ñ‚Ğ½ÑÑ‚Ğ¸Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²*")
    print(f"ğŸ *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ 3 Ñ‚Ğ¸Ğ¿Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²: ĞĞ”Ğ˜ĞĞĞ§ĞĞ«Ğ™, ĞœĞĞĞ“ĞĞ ĞĞ—ĞĞ’Ğ«Ğ™, ĞœĞĞĞ“Ğ ĞŸĞ ĞĞœĞĞšĞĞ”ĞĞ’*")
    print(f"ğŸ“¦ *ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ (ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ…)*")
    print(f"ğŸ“ *Ğ”Ğ»Ñ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ*")
    print(f"âœ… *Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ escape_markdown (None Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ)*")
    print(f"âœ… *Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²*")
    print("\nğŸ“ Ğ”Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /check")
    print(f"ğŸ“Š Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {HIDDEN_USER_ID}: 15,000 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² (Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ² ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞµ)")
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
